<!DOCTYPE html>
<!-- 
    Chaudhary Kirana Store - Admin Panel
    
    IMPORTANT SETUP NOTES:
    1. This file requires a local server to run properly (not file:// protocol)
    2. Use VS Code Live Server extension or similar local server
    3. Firebase Cloud Messaging requires HTTPS or localhost
    4. The firebase-messaging-sw.js file must be in the same directory
    
    To run this admin panel:
    1. Install VS Code Live Server extension
    2. Right-click on this file → "Open with Live Server"
    3. Or use any local server that serves files from this directory
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaudhary Kirana Store - Admin Panel</title>
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-red: #e74a3b;
            --text-color: #333;
            --muted-color: #777;
            --surface-color: #fff;
            --surface-dark-color: #f8f9fa;
            --border-color: #eee;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --card-border-radius: 18px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--surface-dark-color);
            color: var(--text-color);
            line-height: 1.6;
            padding-bottom: 80px; /* Space for bottom navigation */
        }

        /* Fixed Top Header */
        .admin-header {
            background-color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .admin-header .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary-red);
            font-size: 1.2rem;
                font-weight: 700;
        }

        .admin-header .logo span {
            color: var(--primary-red) !important;
        }

        .admin-header .logo i {
            font-size: 1.5rem;
            color: white;
        }

                .admin-header .admin-profile {
                display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-red);
                font-size: 0.9rem;
            font-weight: 600;
        }

        .admin-header .telegram-test-btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .admin-header .telegram-test-btn:hover {
            background: #006699;
            transform: translateY(-1px);
        }



        /* Main Content */
        .admin-content {
            padding: 100px 15px 20px 15px;
            max-width: 1200px;
                margin: 0 auto;
        }

        /* Section Styling */
        .admin-section {
            display: none;
            margin-bottom: 30px;
        }

        /* All sections - consistent spacing */
        .admin-section {
            padding-top: 90px;
        }

        .admin-section h2 {
            margin-bottom: 60px;
        }

        .admin-section .card {
            margin-top: 35px;
        }

        /* Products section specific */
        #products .card {
            margin-top: 25px;
        }



        

        /* Slider section specific */
        #slider .card {
            margin-top: 25px;
        }

        /* Messages section specific */
        #messages .card {
            margin-top: 25px;
        }

        .admin-section.active {
            display: block;
        }

        .admin-section h2 {
            font-size: 1.8rem;
            margin-top: 30px;
            margin-bottom: 20px;
                text-align: center;
            color: var(--primary-red);
            font-weight: 700;
        }

        .admin-section h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--text-color);
            font-weight: 600;
        }

        /* Card Styling */
        .card {
            background-color: var(--surface-color);
            border-radius: var(--card-border-radius);
            box-shadow: 0 4px 15px var(--shadow-color);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        /* Stats Cards */
        #stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--surface-color);
            padding: 25px 20px;
            border-radius: var(--card-border-radius);
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px var(--shadow-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-card .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-red);
            margin-bottom: 10px;
        }

        .stat-card .stat-label {
            font-size: 1rem;
            color: var(--muted-color);
            font-weight: 500;
        }

        /* Button Styling */
            button, .btn {
                background: var(--primary-red);
                color: white;
                border: none;
                border-radius: 12px;
            padding: 12px 20px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
            }

            button:hover, .btn:hover {
                background: #c0392b;
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(231, 74, 59, 0.4);
            }

            #add-product-btn, #add-slider-image-btn {
                background: var(--primary-red);
                color: white;
            padding: 14px 24px;
            font-size: 1rem;
                border-radius: 12px;
            margin: 10px 0;
            display: inline-block;
        }

        /* Time Period Buttons */
            .time-btn {
            background: var(--surface-dark-color);
            color: var(--muted-color);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 16px;
                margin: 5px;
                font-size: 0.9rem;
                font-weight: 500;
            transition: all 0.3s ease;
                display: inline-block;
            }

            .time-btn.active {
                background: var(--primary-red);
                color: white;
                border-color: var(--primary-red);
        }

        /* Table Styling */
            .admin-section table {
                width: 100%;
            border-collapse: collapse;
            background: var(--surface-color);
            border-radius: var(--card-border-radius);
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .admin-section thead {
            background: var(--surface-dark-color);
        }

        .admin-section th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
        }

        .admin-section td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .admin-section tbody tr:last-child td {
                border-bottom: none;
            }

        /* Action Buttons */
            .icon-btn {
            background: var(--surface-dark-color);
            border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 8px 12px;
                margin: 0 3px;
            color: var(--muted-color);
            transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 40px;
                min-height: 40px;
            }

            .icon-btn:hover {
            background: var(--border-color);
                transform: scale(1.05);
            }

            .edit-product-btn, .edit-slider-image-btn {
                background: #e3f2fd;
                color: #1976d2;
                border-color: #bbdefb;
            }

            .delete-product-btn, .delete-slider-image-btn {
                background: #ffebee;
                color: #d32f2f;
                border-color: #ffcdd2;
            }

            .view-order-btn {
                background: #e8f5e8;
                color: #388e3c;
                border-color: #c8e6c9;
            }

        /* Form Styling */
            form {
                display: flex;
                flex-direction: column;
                gap: 20px;
                margin: 20px 0;
            }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: var(--text-color);
        }

        input, textarea, select {
            padding: 12px 16px;
                font-size: 1rem;
            border: 2px solid var(--border-color);
                border-radius: 12px;
            background: var(--surface-dark-color);
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        input:focus, textarea:focus, select:focus {
                border-color: var(--primary-red);
                background: white;
                outline: none;
                box-shadow: 0 0 0 3px rgba(231, 74, 59, 0.1);
            }

        /* Modal Styling */
            .modal-content {
                background: white;
                border-radius: 20px;
            padding: 30px;
                margin: 20px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            max-height: 90vh;
            overflow-y: auto;
            }

        /* Image Styling */
            .admin-product-image, .admin-slider-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
                border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        /* Status Badges */
            .order-status-select {
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid var(--border-color);
            background: var(--surface-dark-color);
                font-size: 0.9rem;
                font-weight: 600;
            color: var(--text-color);
                transition: all 0.3s ease;
            }

            .order-status-select:focus {
                border-color: var(--primary-red);
                box-shadow: 0 0 0 3px rgba(231, 74, 59, 0.1);
            }

        /* Bottom Navigation */
        .admin-bottom-nav {
            background-color: var(--surface-color);
            box-shadow: 0 -2px 10px var(--shadow-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 10px;
            border-top: 1px solid var(--border-color);
        }

        .admin-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--muted-color);
                transition: all 0.3s ease;
            padding: 6px 8px;
            border-radius: 8px;
            min-width: 50px;
            flex: 1;
        }

        .admin-nav-item:hover {
            color: var(--primary-red);
            background-color: var(--surface-dark-color);
        }

        .admin-nav-item.active {
            color: var(--primary-red);
            background-color: rgba(231, 74, 59, 0.1);
        }

        .admin-nav-item i {
            font-size: 1.1rem;
            margin-bottom: 3px;
        }

        .admin-nav-item span {
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading i {
            font-size: 2rem;
            color: var(--primary-red);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .admin-content {
                padding: 90px 10px 20px 10px;
            }

            .admin-header {
                padding: 12px 15px;
            }

            .admin-header .logo {
                font-size: 1rem;
            }

            .admin-header .admin-profile {
                font-size: 0.8rem;
            }



            .admin-section {
                padding-top: 55px;
            }

            .admin-section h2 {
                font-size: 1.5rem;
                margin-bottom: 40px;
            }

            .admin-section h3 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }

            .admin-section .card {
                margin-top: 30px;
            }

            .card {
                padding: 15px;
                margin-bottom: 15px;
            }

            #stats-cards {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .stat-card {
                padding: 20px 15px;
            }

            .stat-card .stat-number {
                font-size: 2rem;
            }

            /* Mobile Table Layout */
            .admin-section table {
                display: block;
                overflow-x: auto;
            }

            .admin-section thead {
                display: none;
            }

            .admin-section tbody,
            .admin-section tr,
            .admin-section td {
                display: block;
            }

            .admin-section tr {
                margin-bottom: 15px;
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 15px;
                background: white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .admin-section td {
                text-align: center;
                padding: 12px 0;
                border: none;
                border-bottom: 1px solid var(--border-color);
                position: relative;
                min-height: 50px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .admin-section td:last-child {
                border-bottom: none;
            }

            .admin-section td::before {
                content: attr(data-label);
                font-weight: 700;
                color: var(--primary-red);
                font-size: 0.8rem;
                margin-bottom: 8px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Special handling for image and action columns */
            .admin-section td:first-child::before,
            .admin-section td:last-child::before {
                display: none;
            }

            .admin-section td:first-child {
                text-align: center;
                justify-content: center;
            }

            .admin-section td:last-child {
                text-align: center;
                justify-content: center;
            }

            /* Mobile Button Layout */
            button, .btn {
                width: 100%;
                max-width: 300px;
                margin: 8px auto;
                display: block;
            }





            /* Mobile Form Layout */
            form input, form textarea, form select {
                width: 100%;
                margin-bottom: 10px;
            }

            /* Mobile Modal Layout */
            .modal-content {
                width: 95%;
                margin: 20px auto;
                padding: 20px;
            }

            /* Mobile Navigation */
            .admin-bottom-nav {
                padding: 10px 5px;
            }

            .admin-nav-item {
                min-width: 45px;
                padding: 5px 4px;
            }

            .admin-nav-item i {
                font-size: 1rem;
            }

            .admin-nav-item span {
                font-size: 0.65rem;
            }

            /* Better mobile touch targets */
            .icon-btn {
                min-width: 50px;
                min-height: 50px;
                margin: 5px;
                border-radius: 12px;
                font-size: 1rem;
                transition: all 0.3s ease;
            }

            .icon-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }

            .icon-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }

            /* Mobile grocery button styling */
            #add-grocery-btn {
                width: 100%;
                max-width: 350px;
                margin: 15px auto;
                display: block;
                padding: 18px 20px;
                font-size: 1rem;
                border-radius: 16px;
                box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            }

            /* Mobile status select styling */
            .order-status-select {
                min-height: 44px;
                font-size: 1rem;
                padding: 12px 16px;
                border-radius: 12px;
                border: 2px solid var(--border-color);
                background: var(--surface-dark-color);
                transition: all 0.3s ease;
                width: 100%;
                max-width: 200px;
                margin: 0 auto;
                display: block;
            }

            .order-status-select:focus {
                border-color: var(--primary-red);
                box-shadow: 0 0 0 3px rgba(231, 74, 59, 0.1);
                background: white;
            }

            /* Enhanced mobile experience */
            .admin-section {
                animation: slideInUp 0.5s ease-out;
            }

            @keyframes slideInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Better mobile shadows and borders */
            .card, .stat-card {
                border: 1px solid rgba(0,0,0,0.1);
                transition: all 0.3s ease;
            }

            .card:hover, .stat-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            }

            /* Mobile-optimized header */
                .admin-header {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.95);
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                }

            /* Mobile-optimized bottom navigation */
                .admin-bottom-nav {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.95);
                border-top: 1px solid rgba(0,0,0,0.1);
            }

            #add-grocery-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
            }

            #add-grocery-btn:active {
                transform: translateY(-1px);
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
            }
        }

        /* Extra Small Devices */
        @media (max-width: 480px) {
            .admin-content {
                padding: 85px 8px 20px 8px;
            }

            .admin-header {
                padding: 10px 12px;
            }

            .admin-header .logo {
                font-size: 0.9rem;
            }

            .admin-section h2 {
                font-size: 1.3rem;
            }

            .admin-section h3 {
                font-size: 1rem;
            }

            .card {
                padding: 12px;
            }

            .stat-card {
                padding: 15px 12px;
            }

            .stat-card .stat-number {
                font-size: 1.8rem;
            }

            button, .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }

            .admin-section td {
                padding: 15px 0;
                min-height: 60px;
            }

            .admin-section td::before {
                font-size: 0.75rem;
            }
        }

        /* Hide sections by default */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        /* Blur overlay for login */
        .blur-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 2999;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            pointer-events: auto;
        }

        .blur-overlay ~ .admin-bottom-nav {
            z-index: 10000 !important;
        }
        /* Mobile-specific table improvements */
        @media (max-width: 768px) {
            .admin-content {
                padding: 15px 10px;
            }
            
            /* Removed specific order-table-container rules to match Products tab responsiveness */
            
            .order-status-select {
                font-size: 12px !important;
                padding: 4px 6px !important;
                min-width: 80px !important;
            }
            
            .view-order-btn,
            .delete-order-btn {
                padding: 4px !important;
                font-size: 14px !important;
            }

                        /* Orders section now matches Products tab responsiveness */
        }

        /* Order cards now use standard card styling for consistent responsiveness */
        
        @media (max-width: 480px) {
            .admin-section {
                padding-top: 40px;
            }

            .admin-section h2 {
                font-size: 1.3rem;
                margin-bottom: 30px;
            }

            /* Removed specific order-table-container rules for consistent responsiveness */
            
            .order-status-select {
                font-size: 11px !important;
                padding: 3px 4px !important;
            }

            .time-btn {
                padding: 5px 10px;
                font-size: 0.75rem;
            }
        }

        /* Modal Close Button Styles */
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-red);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            z-index: 1001;
        }

        .modal-close-btn:hover {
            background: #e74a3b;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(231, 74, 59, 0.4);
        }

        .modal-close-btn:active {
            transform: scale(0.95);
        }

        /* Status Update Button Hover Effects */
        #status-update-btn:hover {
            background-color: #e74a3b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 74, 59, 0.4);
        }

        #status-update-btn:active {
            transform: translateY(0);
        }

        /* Order Progress Step Styles */
        .order-progress-step.completed .progress-step-icon {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(231, 74, 59, 0.3);
        }

        .order-progress-step.completed .progress-step-label {
            color: var(--primary-red);
            font-weight: 600;
        }

        .order-progress-step.current .progress-step-icon {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(231, 74, 59, 0.3);
            animation: pulse 2s infinite;
        }

        .order-progress-step.current .progress-step-label {
            color: var(--primary-red);
            font-weight: 600;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Enhanced Mobile Responsiveness for All Tabs */
        @media (max-width: 768px) {
            /* Notification Panel Mobile Responsiveness */
            #notification-panel {
                width: 90% !important;
                right: 5% !important;
                left: 5% !important;
                max-height: 60vh !important;
            }

            .notification-item {
                padding: 15px !important;
            }

            .notification-item button {
                width: 100% !important;
                margin-top: 10px !important;
                padding: 10px !important;
                font-size: 0.9rem !important;
            }
            /* Enhanced Order Tab Mobile Responsiveness */
            .order-card {
                margin-bottom: 15px !important;
                padding: 12px !important;
            }

            .order-card > div {
                flex-direction: column !important;
                gap: 12px !important;
                text-align: center
            }

            .order-card img {
                width: 80px !important;
                height: 80px !important;
                margin: 0 auto !important;
            }

            .order-status-badge {
                font-size: 0.7rem !important;
                padding: 6px 10px !important;
                min-width: 60px !important;
            }

            .update-status-btn {
                width: 36px !important;
                height: 36px !important;
                margin: 0 auto !important;
            }

            /* Enhanced Products Tab Mobile Responsiveness */
            .admin-product-image {
                width: 60px !important;
                height: 60px !important;
                margin: 0 auto !important;
            }

            /* Enhanced Slider Tab Mobile Responsiveness */
            .admin-slider-image {
                width: 80px !important;
                height: 50px !important;
                margin: 0 auto !important;
            }

            /* Enhanced Messages Tab Mobile Responsiveness */
            .message-cell {
                text-align: center !important;
                padding: 8px !important;
            }

            /* Enhanced Order Progress Steps for Mobile */
            .order-progress-bar {
                display: flex;
                flex-direction: row;
                gap: 15px;
                align-items: center;
                justify-content: center;
                max-width: 350px;
            }

            .order-progress-step {
                flex-direction: column;
                text-align: center;
                min-width: 50px;
            }

            .progress-step-icon {
                margin-bottom: 8px;
            }

            .progress-step-label {
                font-size: 0.8rem;
            }

            /* Enhanced Modal Responsiveness */
            #order-details-modal .card {
                width: 95% !important;
                margin: 10px auto !important;
                padding: 20px !important;
                max-height: 85vh !important;
            }

            #order-details-modal .card > div {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            #status-update-modal .card {
                width: 90% !important;
                margin: 20px auto !important;
                padding: 20px !important;
            }

            #product-manage-modal .card,
            #add-slider-image-modal .card {
                width: 95% !important;
                margin: 20px auto !important;
                padding: 20px !important;
            }

            /* Enhanced Table Container Responsiveness */
            #product-table-container,
            #order-table-container,
            #today-orders-container,
            #slider-image-table-container,
            #messages-table-container {
                overflow-x: hidden;
                padding: 0 5px;
            }
        }

        /* Extra Small Device Responsiveness */
        @media (max-width: 480px) {
            /* Extra small device order card adjustments */
            .order-card {
                padding: 10px !important;
            }

            .order-card img {
                width: 60px !important;
                height: 60px !important;
            }

            .order-status-badge {
                font-size: 0.65rem !important;
                padding: 4px 8px !important;
            }

            .update-status-btn {
                width: 32px !important;
                height: 32px !important;
            }

            /* Extra small device product image adjustments */
            .admin-product-image {
                width: 50px !important;
                height: 50px !important;
            }

            /* Extra small device slider image adjustments */
            .admin-slider-image {
                width: 60px !important;
                height: 40px !important;
            }
        }

        .progress-step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface-dark-color);
            color: var(--muted-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            border: 2px solid var(--border-color);
        }

        .progress-step-label {
            font-size: 0.8rem;
            color: var(--muted-color);
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
        }

        /* Base Order Progress Bar Styles */
        .order-progress-bar {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            position: relative;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .order-progress-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 0px;
            background: transparent;
            z-index: 1;
        }

        .order-progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            background: var(--surface-color);
            padding: 10px;
            border-radius: 8px;
        }

        /* Linear Progress Bar with Connected Steps */
        .order-progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            position: relative;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 20px;
        }

        .order-progress-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50px;
            right: 50px;
            height: 4px;
            background: #e0e0e0;
            z-index: 1;
            transform: translateY(-50%);
            border-radius: 2px;
        }

        .order-progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            background: transparent;
            padding: 8px;
            border-radius: 8px;
            min-width: 80px;
            text-align: center;
        }

        .progress-step-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #f5f5f5;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            border: 4px solid #e0e0e0;
            position: relative;
            font-size: 1.2rem;
        }

        .progress-step-label {
            font-size: 0.75rem;
            color: #666;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        /* Active and Completed Step Styles */
        .order-progress-step.completed .progress-step-icon {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(231, 74, 59, 0.3);
        }

        .order-progress-step.completed .progress-step-label {
            color: var(--primary-red);
            font-weight: 600;
        }

        .order-progress-step.current .progress-step-icon {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(231, 74, 59, 0.3);
            animation: pulse 2s infinite;
        }

        .order-progress-step.current .progress-step-label {
            color: var(--primary-red);
            font-weight: 600;
        }

        /* Progress Line Fill */
        .order-progress-bar::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 30px;
            height: 0px;
            background: transparent;
            z-index: 1;
            transform: translateY(-50%);
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        /* Progress Line Fill for Different Statuses */
        .order-progress-bar[data-progress="25"]::after { width: 25%; }
        .order-progress-bar[data-progress="50"]::after { width: 50%; }
        .order-progress-bar[data-progress="75"]::after { width: 75%; }
        .order-progress-bar[data-progress="100"]::after { width: 100%; }

        /* Individual Circular Progress Steps - Clean Design */
        .order-progress-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            position: relative;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 20px;
            gap: 25px;
        }

        .order-progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            background: transparent;
            padding: 4px;
            border-radius: 8px;
            min-width: 50px;
            text-align: center;
        }

        .progress-step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f5f5f5;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 6px;
            transition: all 0.3s ease;
            border: 2px solid #e0e0e0;
            position: relative;
            font-size: 0.9rem;
        }

        .progress-step-label {
            font-size: 0.75rem;
            color: #666;
            font-weight: 500;
            text-align: center;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        /* Active and Completed Step Styles */
        .order-progress-step.completed .progress-step-icon {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(231, 74, 59, 0.3);
        }

        .order-progress-step.completed .progress-step-label {
            color: var(--primary-red);
            font-weight: 600;
        }

        .order-progress-step.current .progress-step-icon {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
            box-shadow: 0 4px 15px rgba(231, 74, 59, 0.3);
            animation: pulse 2s infinite;
        }

        .order-progress-step.current .progress-step-label {
            color: var(--primary-red);
            font-weight: 600;
        }

        /* Enhanced Mobile Responsiveness for All Tabs */
    </style>
</head>
<body>
    <!-- Fixed Top Header -->
    <header class="admin-header">
        <div class="logo">
            <i class="fas fa-store" style="color: var(--primary-red); font-size: 1.5rem; margin-right: 12px;"></i>
            <span style="font-weight: 700; font-size: 1.2rem; color: white;">Chaudhary Kirana Store</span>
        </div>
        <div class="admin-profile">
            <button class="telegram-test-btn" onclick="testTelegramBot()" style="margin-right: 15px;">
                <i class="fab fa-telegram-plane"></i>
                Test Bot
            </button>
            <div style="position: relative; margin-right: 15px;">
                <i id="notification-icon" class="fas fa-bell" style="color: var(--primary-red); font-size: 1.2rem; cursor: pointer; transition: color 0.3s ease;" title="Notifications"></i>
                <span id="notification-badge" style="position: absolute; top: -8px; right: -8px; background: #dc3545; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: none; align-items: center; justify-content: center; font-weight: bold;">0</span>
            </div>
            <button id="enable-notifications-btn" style="background: none; border: 1px solid var(--primary-red); color: var(--primary-red); padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; margin-right: 15px; display: none;" title="Enable Notifications">
                <i class="fas fa-bell-slash" style="margin-right: 5px;"></i>Enable
            </button>
            <i id="admin-shield-icon" class="fas fa-user-shield" style="color: var(--primary-red); font-size: 1.2rem; transition: color 0.3s ease;" title="Checking connection..."></i>
        </div>
    </header>

    <!-- Notification Panel -->
    <div id="notification-panel" style="display: none; position: fixed; top: 70px; right: 20px; width: 350px; max-height: 400px; background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); z-index: 2000; overflow-y: auto; border: 1px solid var(--border-color);">
        <div style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h4 style="margin: 0; color: var(--text-color); font-size: 1rem;">Notifications</h4>
            <button id="clear-all-notifications-btn" style="background: none; border: none; color: var(--primary-red); cursor: pointer; font-size: 0.8rem;">Clear All</button>
        </div>
        <div id="notification-list" style="padding: 10px;">
            <!-- Notifications will be populated here -->
        </div>
    </div>

    <div id="admin-content-wrapper">
        <main class="admin-content" id="admin-content">

            <div class="container">


                <section id="products" class="admin-section">
                    <h2>Products</h2>
                    


                    <!-- Products Management Section -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--text-color);">Product List</h3>
                            <button id="add-product-btn" style="background-color: var(--primary-red); color: white; padding: 12px 20px; border-radius: 8px; font-weight: 600;">
                                <i class="fas fa-plus" style="margin-right: 8px;"></i>Add Product
                            </button>
                        </div>
                        <div id="product-table-container">
                            <!-- Product table will be loaded here -->
                            <p style="text-align: center; color: var(--muted-color);">No products to display.</p>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button id="add-grocery-btn" style="background-color: #28a745; color: white; padding: 15px 25px; border-radius: 12px; font-weight: 600; margin: 10px; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                                <i class="fas fa-shopping-cart" style="margin-right: 10px; font-size: 1.2rem;"></i>
                                <span style="font-size: 1.1rem;">Add Grocery Products from Zepto</span>
                            </button>
                        </div>
                    </div>
                </section>

                <section id="orders" class="admin-section">
                    <h2>Orders</h2>
                    

                    
                    <!-- Orders Management Section -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--text-color);">Order List</h3>
                            <div style="display: flex; gap: 8px;">
                                <span style="color: var(--muted-color); font-size: 0.9rem;">All orders</span>
                            </div>
                        </div>
                        
                        <!-- Search Section -->
                        <div style="margin-bottom: 20px; padding: 15px; background: var(--surface-dark-color); border-radius: 12px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <i class="fas fa-search" style="color: var(--primary-red); font-size: 1.1rem;"></i>
                                <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: var(--text-color);">Search Orders</h4>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                <div style="position: relative; flex: 1; min-width: 250px;">
                                    <input type="text" id="order-search-input" placeholder="Search by Order ID or Customer Name..." style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; background: white; transition: all 0.3s ease; box-sizing: border-box;">
                                </div>
                                <button id="order-clear-search-btn" style="background: var(--surface-dark-color); color: var(--muted-color); padding: 10px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; font-size: 0.9rem;">
                                    <i class="fas fa-times" style="margin-right: 6px;"></i>Clear
                                </button>
                            </div>
                            <div id="search-results-info" style="margin-top: 10px; font-size: 0.85rem; color: var(--muted-color); display: none;">
                                <!-- Search results info will be shown here -->
                            </div>
                        </div>
                        
                        <div id="order-table-container">
                            <!-- Order table will be loaded here -->
                            <p style="text-align: center; color: var(--muted-color);">No orders to display.</p>
                        </div>
                    </div>
                </section>

                <section id="today-orders" class="admin-section active">
                    <h2>Today Orders</h2>
                    
                    <!-- Today Orders Section -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--text-color);">Today's Order List</h3>
                            <div style="display: flex; gap: 8px;">
                                <span style="color: var(--muted-color); font-size: 0.9rem;">Orders placed today</span>
                            </div>
                        </div>
                        <div id="today-orders-container">
                            <!-- Today's orders will be loaded here -->
                            <p style="text-align: center; color: var(--muted-color);">No orders placed today.</p>
                        </div>
                    </div>
                </section>

                <section id="slider" class="admin-section">
                    <h2>Slider / Ad Management</h2>
                    
                    <!-- Slider Management Section -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--text-color);">Slider Images</h3>
                            <button id="add-slider-image-btn" style="background-color: #007bff; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 600;">
                                <i class="fas fa-plus-circle" style="margin-right: 8px;"></i>Add New Slider Image
                            </button>
                    </div>
                        <div id="slider-image-table-container">
                        <!-- Slider image table will be loaded here -->
                        <p style="text-align: center; color: var(--muted-color);">No slider images to display.</p>
                        </div>
                    </div>
                </section>

                <section id="messages" class="admin-section">
                    <h2>Customer Messages</h2>
                    
                    <!-- Messages Management Section -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 600; color: var(--text-color);">Message List</h3>
                            <div style="display: flex; gap: 8px;">
                                <span style="color: var(--muted-color); font-size: 0.9rem;">Customer inquiries and feedback</span>
                            </div>
                        </div>
                        <div id="messages-table-container">
                        <!-- Messages table will be loaded here -->
                        <p style="text-align: center; color: var(--muted-color);">No messages to display.</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="sidebar-backdrop" class="sidebar-backdrop"></div>

    <!-- Message View Modal -->
    <div id="message-view-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 3000;">
        <div class="card" style="width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 30px; position: relative;">
            <button style="position: absolute; top: 10px; right: 10px; background: var(--primary-red); color: white; border: none; font-size: 1.2rem; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1001;" onclick="document.getElementById('message-view-modal').style.display = 'none';">
                <i class="fas fa-times"></i>
            </button>
            <h3 style="margin-bottom: 20px; color: var(--text-color); margin-top: 10px;">Customer Message</h3>
            <div id="message-modal-content">
                <!-- Message details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-auth-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 3000;">
        <div class="card" style="width: 90%; max-width: 400px; padding: 30px; text-align: center;">
            <h3>Admin Login</h3>
            <form id="admin-auth-form">
                <input type="email" id="admin-email" placeholder="Email" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                <input type="password" id="admin-password" placeholder="Password" required style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px;">
                <p id="admin-auth-error" style="color: var(--primary-red); margin-bottom: 15px; display: none;"></p>
                <button type="submit" id="admin-login-btn" style="background-color: var(--primary-red); color: white; width: 100%;"><i class="fas fa-sign-in-alt" style="margin-right: 5px;"></i>Login</button>
            </form>
        </div>
    </div>

    <!-- Product Add/Edit Modal -->
    <div id="product-manage-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000;">
        <div class="card" style="width: 90%; max-width: 600px; padding: 30px; position: relative;">
            <button style="position: absolute; top: 10px; right: 10px; background: var(--primary-red); color: white; border: none; font-size: 1.2rem; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1001;" onclick="document.getElementById('product-manage-modal').style.display = 'none';">
                <i class="fas fa-times"></i>
            </button>
            <h3 style="margin-top: 10px;">Add/Edit Product</h3>
            <form id="product-manage-form">
                <input type="text" id="product-name" placeholder="Product Name" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                <input type="text" id="product-category" placeholder="Category" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                <input type="number" id="product-price" placeholder="Price" step="0.01" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                <input type="url" id="product-image-url" placeholder="Image URL" required style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                <textarea id="product-description" placeholder="Description" rows="5" required style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px;"></textarea>
                <button type="submit" style="background-color: var(--primary-red); color: white; width: 100%;"><i class="fas fa-save" style="margin-right: 5px;"></i>Save Product</button>
            </form>
        </div>
    </div>

    <!-- Add Slider Image Modal -->
    <div id="add-slider-image-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000;">
        <div class="card" style="width: 90%; max-width: 400px; padding: 30px; position: relative; text-align: center;">
            <button style="position: absolute; top: 10px; right: 10px; background: var(--primary-red); color: white; border: none; font-size: 1.2rem; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1001;" onclick="document.getElementById('add-slider-image-modal').style.display = 'none';">
                <i class="fas fa-times"></i>
            </button>
            <h3 style="margin-top: 10px;">Add Slider Image</h3>
            <form id="add-slider-image-form">
                <input type="url" id="slider-image-url-input" placeholder="Image URL" required style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px;">
                <button type="submit" style="background-color: var(--primary-red); color: white; width: 100%;"><i class="fas fa-plus-circle" style="margin-right: 5px;"></i>Add Image</button>
            </form>
        </div>
    </div>

    <!-- Order Details Full Screen Modal -->
    <div id="order-details-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 3000;">
        <div class="card" style="width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative;">
            <button class="icon-btn modal-close-btn" style="position: absolute; top: 15px; right: 15px; font-size: 1.5rem; color: white; background: var(--primary-red); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>
            
            <div id="order-details-content">
                <!-- Order details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="status-update-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 3000;">
        <div class="card" style="width: 90%; max-width: 400px; padding: 30px; position: relative; text-align: center;">
            <button class="modal-close-btn" style="position: absolute; top: 10px; right: 10px; width: 32px; height: 32px; border-radius: 50%; background: var(--primary-red); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; transition: all 0.2s ease;" onclick="document.getElementById('status-update-modal').style.display = 'none';">
                <i class="fas fa-times"></i>
            </button>
            <h3 style="color: var(--primary-red); margin-bottom: 20px;">Update Order Status</h3>
            <div style="margin-bottom: 20px;">
                <label for="status-update-select" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color);">Select New Status:</label>
                <select id="status-update-select" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;">
                    <option value="Pending">Pending</option>
                    <option value="Processing">Processing</option>
                    <option value="Shipped">Shipped</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>
            <button id="status-update-btn" style="background-color: var(--primary-red); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.2s ease;">
                Update Status
            </button>
        </div>
    </div>


    <script type="module">
        // Firebase Configuration (Placeholder)
        const firebaseConfig = {
  apiKey: "AIzaSyBGh16sYlLk1e9nkhcLu7IPTZk807qeLZM",
  authDomain: "test-60bf6.firebaseapp.com",
  databaseURL: "https://test-60bf6-default-rtdb.firebaseio.com",
  projectId: "test-60bf6",
  storageBucket: "test-60bf6.firebasestorage.app",
  messagingSenderId: "208881094528",
  appId: "1:208881094528:web:114768e2de5956cae6fb65"
};


        // Initialize Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, remove, update, onDisconnect, get } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-messaging.js";

        let app, auth, database, messaging;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            database = getDatabase(app);
            messaging = getMessaging(app);
        } catch (error) {
            console.error('Firebase initialization failed:', error);
            showFallbackStats();
        }

        // FCM Configuration
        const VAPID_KEY = 'BBFeIMCAfLWcKzaYe4I6jXtVsR61Vu5tl5M7ZPF6BYkeeJ8XsybOnWF2dANauR-LaVzxoLo3F_AZUK8vg7AlBMc';

        // Telegram Bot Configuration
        const TELEGRAM_BOT_TOKEN = '7119533193:AAGYRk2OO7D1xQAmeYeJA_FU7dPcrj35kGE';
        const TELEGRAM_CHAT_IDS = ['7298169399', '5744191135']; // Multiple admin chat IDs

        // Function to test Telegram bot
        async function testTelegramBot() {
            try {
                const testOrderData = {
                    orderId: 'TEST_' + Date.now(),
                    shippingName: 'Test Customer',
                    shippingMobile: '+91 98765 43210',
                    shippingAddress: 'Test Address, Test City',
                    totalAmount: 299.99,
                    items: [
                        { name: 'Test Product 1', price: 149.99, quantity: 1 },
                        { name: 'Test Product 2', price: 150.00, quantity: 1 }
                    ],
                    date: Date.now(),
                    status: 'Pending'
                };

                console.log('Testing Telegram bot with sample order...');
                await sendTelegramNotification(testOrderData, 'new_order');
                
                // Show success message
                alert('✅ Telegram test notification sent! Check your Telegram app.');
                
            } catch (error) {
                console.error('Error testing Telegram bot:', error);
                alert('❌ Error testing Telegram bot. Check console for details.');
            }
        }

        // Function to handle incoming bot commands
        async function handleBotCommands(update) {
            try {
                if (!update.message || !update.message.text) return;
                
                const chatId = update.message.chat.id;
                const text = update.message.text;
                const messageId = update.message.message_id;
                
                // Check if this is a command
                if (!text.startsWith('/')) return;
                
                const command = text.split(' ')[0].toLowerCase();
                const args = text.split(' ').slice(1);
                
                console.log(`Bot command received: ${command} with args:`, args);
                
                let response = '';
                
                switch (command) {
                    case '/start':
                        response = `🚀 Welcome to Chaudhary Kirana Store Bot!

I can help you manage orders and get updates.

Available commands:
📋 /orders - View recent orders
🔍 /status [orderId] - Check order status
🔄 /update [orderId] [status] - Update order status
✅ /complete [orderId] - Mark order complete
❌ /cancel [orderId] - Cancel order
📊 /stats - View statistics
❓ /help - Show this help message`;
                        break;
                        
                    case '/help':
                        response = `📚 Bot Commands Help:

📋 /orders - View recent orders
🔍 /status [orderId] - Check order status
🔄 /update [orderId] [status] - Update order status
✅ /complete [orderId] - Mark order complete
❌ /cancel [orderId] - Cancel order
📊 /stats - View statistics
❓ /help - Show this help message

Example: /update ORDER123 Processing`;
                        break;
                        
                    case '/orders':
                        response = await getRecentOrdersMessage();
                        break;
                        
                    case '/status':
                        if (args.length < 1) {
                            response = '❌ Please provide order ID\nExample: /status ORDER123';
                        } else {
                            response = await getOrderStatusMessage(args[0]);
                        }
                        break;
                        
                    case '/update':
                        if (args.length < 2) {
                            response = '❌ Please provide order ID and status\nExample: /update ORDER123 Processing';
                        } else {
                            response = await updateOrderStatusFromBot(args[0], args[1]);
                        }
                        break;
                        
                    case '/complete':
                        if (args.length < 1) {
                            response = '❌ Please provide order ID\nExample: /complete ORDER123';
                        } else {
                            response = await updateOrderStatusFromBot(args[0], 'Completed');
                        }
                        break;
                        
                    case '/cancel':
                        if (args.length < 1) {
                            response = '❌ Please provide order ID\nExample: /cancel ORDER123';
                        } else {
                            response = await updateOrderStatusFromBot(args[0], 'Cancelled');
                        }
                        break;
                        
                    case '/stats':
                        response = await getStatsMessage();
                        break;
                        
                    default:
                        response = '❓ Unknown command. Type /help for available commands.';
                }
                
                // Send response back to Telegram
                await sendTelegramMessage(chatId, response);
                
            } catch (error) {
                console.error('Error handling bot command:', error);
                await sendTelegramMessage(chatId, '❌ Error processing command. Please try again.');
            }
        }

        // Function to send message to specific chat
        async function sendTelegramMessage(chatId, message) {
            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'HTML',
                        disable_web_page_preview: true
                    })
                });

                if (response.ok) {
                    console.log(`Telegram message sent to chat ID: ${chatId}`);
                } else {
                    const errorData = await response.json();
                    console.error(`Failed to send Telegram message to ${chatId}:`, errorData);
                }
            } catch (error) {
                console.error(`Error sending Telegram message to ${chatId}:`, error);
            }
        }

        // Function to get recent orders message
        async function getRecentOrdersMessage() {
            try {
                if (!database) return '❌ Database not available';
                
                const ordersRef = ref(database, 'orders');
                const snapshot = await get(ordersRef);
                const allOrders = snapshot.val() || {};
                
                if (Object.keys(allOrders).length === 0) {
                    return '📭 No orders found';
                }
                
                let message = '📋 <b>Recent Orders:</b>\n\n';
                let orderCount = 0;
                
                // Get recent orders (last 10)
                const recentOrders = [];
                for (const userId in allOrders) {
                    for (const orderId in allOrders[userId]) {
                        const order = allOrders[userId][orderId];
                        recentOrders.push({
                            orderId,
                            userId,
                            ...order,
                            timestamp: order.date || Date.now()
                        });
                    }
                }
                
                // Sort by date (most recent first)
                recentOrders.sort((a, b) => b.timestamp - a.timestamp);
                
                // Show last 10 orders
                recentOrders.slice(0, 10).forEach((order, index) => {
                    const orderTime = new Date(order.timestamp).toLocaleString('en-IN');
                    const status = order.status || 'Pending';
                    const statusEmoji = getStatusEmoji(status);
                    
                    message += `${index + 1}. <b>${order.orderId}</b>\n`;
                    message += `   👤 ${order.shippingName || 'N/A'}\n`;
                    message += `   📱 ${order.shippingMobile || 'N/A'}\n`;
                    message += `   💰 ₹${order.totalAmount ? order.totalAmount.toFixed(2) : '0.00'}\n`;
                    message += `   ${statusEmoji} ${status}\n`;
                    message += `   ⏰ ${orderTime}\n\n`;
                    
                    orderCount++;
                });
                
                if (orderCount === 0) {
                    return '📭 No recent orders found';
                }
                
                message += `📊 Total orders: ${Object.keys(allOrders).length}`;
                return message;
                
            } catch (error) {
                console.error('Error getting recent orders:', error);
                return '❌ Error fetching orders';
            }
        }

        // Function to get order status message
        async function getOrderStatusMessage(orderId) {
            try {
                if (!database) return '❌ Database not available';
                
                const ordersRef = ref(database, 'orders');
                const snapshot = await get(ordersRef);
                const allOrders = snapshot.val() || {};
                
                // Search for order
                let foundOrder = null;
                let foundUserId = null;
                
                for (const userId in allOrders) {
                    for (const orderIdKey in allOrders[userId]) {
                        if (orderIdKey === orderId) {
                            foundOrder = allOrders[userId][orderIdKey];
                            foundUserId = userId;
                            break;
                        }
                    }
                    if (foundOrder) break;
                }
                
                if (!foundOrder) {
                    return `❌ Order <b>${orderId}</b> not found`;
                }
                
                const orderTime = new Date(foundOrder.date).toLocaleString('en-IN');
                const status = foundOrder.status || 'Pending';
                const statusEmoji = getStatusEmoji(status);
                
                let message = `🔍 <b>Order Status: ${orderId}</b>\n\n`;
                message += `👤 <b>Customer:</b> ${foundOrder.shippingName || 'N/A'}\n`;
                message += `📱 <b>Phone:</b> ${foundOrder.shippingMobile || 'N/A'}\n`;
                message += `📍 <b>Address:</b> ${foundOrder.shippingAddress || 'N/A'}\n`;
                message += `💰 <b>Total:</b> ₹${foundOrder.totalAmount ? foundOrder.totalAmount.toFixed(2) : '0.00'}\n`;
                message += `📦 <b>Items:</b> ${foundOrder.items ? foundOrder.items.length : 0} item(s)\n`;
                message += `${statusEmoji} <b>Status:</b> ${status}\n`;
                message += `⏰ <b>Order Time:</b> ${orderTime}\n\n`;
                
                if (foundOrder.items && foundOrder.items.length > 0) {
                    message += `🛒 <b>Products:</b>\n`;
                    foundOrder.items.forEach((item, index) => {
                        message += `${index + 1}. ${item.name} - ₹${item.price} x ${item.quantity}\n`;
                    });
                }
                
                return message;
                
            } catch (error) {
                console.error('Error getting order status:', error);
                return '❌ Error fetching order status';
            }
        }

        // Function to update order status from bot
        async function updateOrderStatusFromBot(orderId, newStatus) {
            try {
                if (!database) return '❌ Database not available';
                
                const ordersRef = ref(database, 'orders');
                const snapshot = await get(ordersRef);
                const allOrders = snapshot.val() || {};
                
                // Search for order
                let foundOrder = null;
                let foundUserId = null;
                
                for (const userId in allOrders) {
                    for (const orderIdKey in allOrders[userId]) {
                        if (orderIdKey === orderId) {
                            foundOrder = allOrders[userId][orderIdKey];
                            foundUserId = userId;
                            break;
                        }
                    }
                    if (foundOrder) break;
                }
                
                if (!foundOrder) {
                    return `❌ Order <b>${orderId}</b> not found`;
                }
                
                // Update order status
                const orderRef = ref(database, `orders/${foundUserId}/${orderId}`);
                await update(orderRef, { status: newStatus });
                
                // Send notification to admin panel
                const updatedOrderData = { ...foundOrder, status: newStatus };
                sendTelegramNotification(updatedOrderData, 'status_update');
                
                return `✅ Order <b>${orderId}</b> status updated to <b>${newStatus}</b>`;
                
            } catch (error) {
                console.error('Error updating order status from bot:', error);
                return '❌ Error updating order status';
            }
        }

        // Function to get statistics message
        async function getStatsMessage() {
            try {
                if (!database) return '❌ Database not available';
                
                const ordersRef = ref(database, 'orders');
                const snapshot = await get(ordersRef);
                const allOrders = snapshot.val() || {};
                
                if (Object.keys(allOrders).length === 0) {
                    return '📊 <b>Statistics:</b>\n\n📭 No orders found';
                }
                
                // Calculate statistics
                let totalOrders = 0;
                let totalRevenue = 0;
                let pendingOrders = 0;
                let completedOrders = 0;
                let cancelledOrders = 0;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTimestamp = today.getTime();
                let todayOrders = 0;
                let todayRevenue = 0;
                
                for (const userId in allOrders) {
                    for (const orderId in allOrders[userId]) {
                        const order = allOrders[userId][orderId];
                        totalOrders++;
                        totalRevenue += order.totalAmount || 0;
                        
                        const status = order.status || 'Pending';
                        if (status === 'Pending') pendingOrders++;
                        else if (status === 'Completed') completedOrders++;
                        else if (status === 'Cancelled') cancelledOrders++;
                        
                        // Check if order is from today
                        const orderDate = new Date(order.date);
                        orderDate.setHours(0, 0, 0, 0);
                        if (orderDate.getTime() === todayTimestamp) {
                            todayOrders++;
                            todayRevenue += order.totalAmount || 0;
                        }
                    }
                }
                
                let message = '📊 <b>Store Statistics:</b>\n\n';
                message += `📦 <b>Total Orders:</b> ${totalOrders}\n`;
                message += `💰 <b>Total Revenue:</b> ₹${totalRevenue.toFixed(2)}\n\n`;
                
                message += `📅 <b>Today:</b>\n`;
                message += `   📦 Orders: ${todayOrders}\n`;
                message += `   💰 Revenue: ₹${todayRevenue.toFixed(2)}\n\n`;
                
                message += `📊 <b>Order Status:</b>\n`;
                message += `   ⏳ Pending: ${pendingOrders}\n`;
                message += `   ✅ Completed: ${completedOrders}\n`;
                message += `   ❌ Cancelled: ${cancelledOrders}\n`;
                
                return message;
                
            } catch (error) {
                console.error('Error getting statistics:', error);
                return '❌ Error fetching statistics';
            }
        }

        // Helper function to get status emoji
        function getStatusEmoji(status) {
            const statusLower = status.toLowerCase();
            if (statusLower === 'pending') return '⏳';
            if (statusLower === 'processing') return '🔄';
            if (statusLower === 'shipped') return '🚚';
            if (statusLower === 'delivered') return '✅';
            if (statusLower === 'completed') return '✅';
            if (statusLower === 'cancelled') return '❌';
            return '📋';
        }

                // Function to send Telegram notification
        async function sendTelegramNotification(orderData, notificationType = 'new_order') {
            try {
                if (!TELEGRAM_BOT_TOKEN || TELEGRAM_CHAT_IDS.length === 0) {
                    console.log('Telegram bot not configured');
                    return;
                }

                let message = '';
                let emoji = '';

                if (notificationType === 'new_order') {
                    emoji = '🆕';
                    message = `${emoji} <b>NEW ORDER RECEIVED!</b>

📦 <b>Order ID:</b> ${orderData.orderId || 'N/A'}
👤 <b>Customer:</b> ${orderData.shippingName || 'N/A'}
📱 <b>Phone:</b> ${orderData.shippingMobile || 'N/A'}
📍 <b>Address:</b> ${orderData.shippingAddress || 'N/A'}
💰 <b>Total Amount:</b> ₹${orderData.totalAmount ? orderData.totalAmount.toFixed(2) : '0.00'}
📦 <b>Items:</b> ${orderData.items ? orderData.items.length : 0} item(s)
⏰ <b>Time:</b> ${new Date(orderData.date).toLocaleString('en-IN')}

🛒 <b>Products:</b>
${orderData.items ? orderData.items.map(item => `• ${item.name} - ₹${item.price} x ${item.quantity}`).join('\n') : 'No items'}`;

                } else if (notificationType === 'status_update') {
                    emoji = '🔄';
                    message = `${emoji} <b>ORDER STATUS UPDATED!</b>

📦 <b>Order ID:</b> ${orderData.orderId || 'N/A'}
👤 <b>Customer:</b> ${orderData.shippingName || 'N/A'}
📱 <b>Phone:</b> ${orderData.shippingMobile || 'N/A'}
🔄 <b>New Status:</b> ${orderData.status || 'N/A'}
⏰ <b>Updated Time:</b> ${new Date().toLocaleString('en-IN')}`;

                } else if (notificationType === 'order_cancelled') {
                    emoji = '❌';
                    message = `${emoji} <b>ORDER CANCELLED!</b>

📦 <b>Order ID:</b> ${orderData.orderId || 'N/A'}
👤 <b>Customer:</b> ${orderData.shippingName || 'N/A'}
📱 <b>Phone:</b> ${orderData.shippingMobile || 'N/A'}
❌ <b>Status:</b> Cancelled
⏰ <b>Cancelled Time:</b> ${new Date().toLocaleString('en-IN')}`;
                }

                // Send notification to all admin chat IDs
                for (const chatId of TELEGRAM_CHAT_IDS) {
                    try {
                        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                chat_id: chatId,
                                text: message,
                                parse_mode: 'HTML',
                                disable_web_page_preview: true
                            })
                        });

                        if (response.ok) {
                            console.log(`Telegram notification sent to chat ID: ${chatId}`);
                        } else {
                            const errorData = await response.json();
                            console.error(`Failed to send Telegram notification to ${chatId}:`, errorData);
                        }
                    } catch (error) {
                        console.error(`Error sending Telegram notification to ${chatId}:`, error);
                    }
                }

            } catch (error) {
                console.error('Error in sendTelegramNotification:', error);
            }
        }

        // Set up Telegram webhook for bot commands
        async function setupTelegramWebhook() {
            try {
                // Set webhook to receive updates
                const webhookUrl = `${window.location.origin}/telegram-webhook`;
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: webhookUrl,
                        allowed_updates: ['message']
                    })
                });

                if (response.ok) {
                    console.log('Telegram webhook set successfully');
                } else {
                    console.log('Webhook setup failed, using polling instead');
                    // Start polling for updates
                    startTelegramPolling();
                }
            } catch (error) {
                console.log('Webhook setup failed, using polling instead:', error);
                // Start polling for updates
                startTelegramPolling();
            }
        }

        // Start polling for Telegram updates
        function startTelegramPolling() {
            let offset = 0;
            
            async function pollUpdates() {
                try {
                    const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates?offset=${offset}&timeout=30`);
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.ok && data.result && data.result.length > 0) {
                            for (const update of data.result) {
                                await handleBotCommands(update);
                                offset = update.update_id + 1;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error polling Telegram updates:', error);
                }
                
                // Continue polling
                setTimeout(pollUpdates, 5000); // Poll every 5 seconds
            }
            
            // Start polling
            pollUpdates();
        }

        // Initialize FCM and request permission
            try {
                // Check if we have saved notification permission
                const savedPermission = localStorage.getItem('notificationPermission');
                if (savedPermission) {
                    console.log('Saved notification permission:', savedPermission);
                }
                
                // Check if permission is already granted or denied
                let permission = Notification.permission;
                
                // If permission is default (not asked yet), request it
                if (permission === 'default') {
                    permission = await Notification.requestPermission();
                }
                
                // Save permission state to localStorage
                localStorage.setItem('notificationPermission', permission);
                
                if (permission === 'granted') {
                    console.log('Admin notification permission granted');
                    
                    // Check if we're on a supported protocol for FCM
                    if (window.location.protocol === 'file:' || window.location.protocol === 'null') {
                        console.log('FCM not supported on file:// protocol, skipping token generation');
                        // Still save admin profile without FCM token
                        if (auth.currentUser) {
                            const adminProfileRef = ref(database, `admins/${auth.currentUser.uid}`);
                            await set(adminProfileRef, {
                                email: auth.currentUser.email,
                                lastActive: Date.now(),
                                fcmSupported: false
                            });
                        }
                        return;
                    }
                    
                    // Check if messaging is available and properly initialized
                    if (!messaging) {
                        console.log('Firebase messaging not available, skipping FCM token generation');
                        if (auth.currentUser) {
                            const adminProfileRef = ref(database, `admins/${auth.currentUser.uid}`);
                            await set(adminProfileRef, {
                                email: auth.currentUser.email,
                                lastActive: Date.now(),
                                fcmSupported: false
                            });
                        }
                        return;
                    }
                    
                    // Get FCM token only on supported protocols
                    try {
                        const token = await getToken(messaging, { vapidKey: VAPID_KEY });
                        if (token) {
                            console.log('Admin FCM Token:', token);
                            
                            // Save admin token to adminTokens/
                            const adminId = auth.currentUser?.uid || 'admin_' + Date.now();
                            const adminTokenRef = ref(database, `adminTokens/${adminId}`);
                            await set(adminTokenRef, token);
                            
                            // Update admin profile with token
                            if (auth.currentUser) {
                                const adminProfileRef = ref(database, `admins/${auth.currentUser.uid}`);
                                await set(adminProfileRef, {
                                    email: auth.currentUser.email,
                                    fcmToken: token,
                                    lastActive: Date.now(),
                                    fcmSupported: true
                                });
                            }
                        }
                    } catch (fcmError) {
                        console.log('FCM token generation failed:', fcmError.message);
                        
                        // Check if it's a service worker registration issue
                        if (fcmError.message.includes('service worker') || fcmError.message.includes('404')) {
                            console.log('Service worker registration issue detected, FCM will be limited');
                        }
                        
                        // Save admin profile without FCM token
                        if (auth.currentUser) {
                            const adminProfileRef = ref(database, `admins/${auth.currentUser.uid}`);
                            await set(adminProfileRef, {
                                email: auth.currentUser.email,
                                lastActive: Date.now(),
                                fcmSupported: false,
                                fcmError: fcmError.message
                            });
                        }
                    }
                } else if (permission === 'denied') {
                    console.log('Admin notification permission denied - user blocked it');
                    // Show a message to user about enabling notifications
                    showNotificationPermissionMessage();
                } else {
                    console.log('Admin notification permission not granted');
                }
            } catch (error) {
                console.error('Error initializing admin FCM:', error);
                // If FCM fails, still try to save admin profile without token
                if (auth.currentUser) {
                    try {
                        const adminProfileRef = ref(database, `admins/${auth.currentUser.uid}`);
                        await set(adminProfileRef, {
                            email: auth.currentUser.email,
                            lastActive: Date.now(),
                            fcmSupported: false,
                            fcmError: error.message
                        });
                    } catch (profileError) {
                        console.error('Error saving admin profile:', profileError);
                    }
                }
            }
        }

        // Show message about notification permission
        function showNotificationPermissionMessage() {
            // Show the enable notifications button instead of a message
            const enableBtn = document.getElementById('enable-notifications-btn');
            if (enableBtn) {
                enableBtn.style.display = 'inline-block';
            }
        }

        // Manual notification permission request
        async function requestNotificationPermission() {
            try {
                const permission = await Notification.requestPermission();
                localStorage.setItem('notificationPermission', permission);
                
                if (permission === 'granted') {
                    console.log('Notification permission granted manually');
                    
                    // Hide the enable button
                    const enableBtn = document.getElementById('enable-notifications-btn');
                    if (enableBtn) {
                        enableBtn.style.display = 'none';
                    }
                    
                    // Try to get FCM token again
                    await initializeAdminFCM();
                } else {
                    console.log('Notification permission still denied');
                    // Show a more helpful message
                    alert('To receive notifications, please enable them in your browser settings:\n\n1. Click the lock/info icon in the address bar\n2. Set "Notifications" to "Allow"\n3. Refresh the page');
                }
            } catch (error) {
                console.error('Error requesting notification permission:', error);
            }
        }

        // Update UI based on notification permission
        function updateNotificationUI() {
            const enableBtn = document.getElementById('enable-notifications-btn');
            const notificationIcon = document.getElementById('notification-icon');
            
            if (Notification.permission === 'granted') {
                if (enableBtn) enableBtn.style.display = 'none';
                if (notificationIcon) notificationIcon.style.color = 'var(--primary-red)';
            } else {
                if (enableBtn) enableBtn.style.display = 'inline-block';
                if (notificationIcon) notificationIcon.style.color = '#ccc';
            }
        }

        // Show warning about protocol issue
        function showProtocolWarning() {
            // Create a warning message in the admin header
            const adminHeader = document.querySelector('.admin-header');
            if (adminHeader) {
                const warningDiv = document.createElement('div');
                warningDiv.id = 'protocol-warning';
                warningDiv.style.cssText = `
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: #f8d7da;
                    color: #721c24;
                    padding: 15px 20px;
                    font-size: 0.9rem;
                    text-align: center;
                    border: 1px solid #f5c6cb;
                    z-index: 1001;
                    line-height: 1.4;
                `;
                warningDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                    <strong>Development Environment Warning:</strong> Push notifications and some features may not work properly when opening files directly. 
                    <br><strong>Solution:</strong> Use Live Server in VS Code (right-click → "Open with Live Server") or deploy to HTTPS hosting.
                    <br><small>See README.md for detailed setup instructions.</small>
                    <button onclick="this.parentElement.remove()" style="background: none; border: none; color: #721c24; margin-left: 10px; cursor: pointer; font-size: 1.2rem; padding: 5px;">×</button>
                `;
                adminHeader.style.position = 'relative';
                adminHeader.appendChild(warningDiv);
            }
        }

        // Check if current environment supports FCM
        function checkFCMSupport() {
            const protocol = window.location.protocol;
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            if (protocol === 'https:' || (protocol === 'http:' && isLocalhost)) {
                return true;
            } else {
                return false;
            }
        }

        // Initialize FCM and request permission
        async function initializeAdminFCM() {

        // Show environment status in admin header
        function showEnvironmentStatus() {
            const adminProfile = document.querySelector('.admin-profile');
            if (adminProfile) {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'environment-status';
                statusDiv.style.cssText = `
                    position: absolute;
                    top: 100%;
                    right: 0;
                    background: #d4edda;
                    color: #155724;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 0.75rem;
                    margin-top: 5px;
                    white-space: nowrap;
                    border: 1px solid #c3e6cb;
                    max-width: 200px;
                    text-align: center;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                `;
                
                const protocol = window.location.protocol;
                const hostname = window.location.hostname;
                
                if (protocol === 'https:' || (protocol === 'http:' && (hostname === 'localhost' || hostname === '127.0.0.1'))) {
                    statusDiv.innerHTML = '<i class="fas fa-check-circle" style="margin-right: 5px;"></i>Environment: Optimal<br><small>FCM & Service Workers Supported</small>';
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.style.borderColor = '#c3e6cb';
                } else if (protocol === 'http:' && hostname !== 'localhost' && hostname !== '127.0.0.1') {
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle" style="margin-right: 5px;"></i>Environment: Limited<br><small>HTTPS Required for FCM</small>';
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.color = '#856404';
                    statusDiv.style.borderColor = '#ffeaa7';
                } else {
                    statusDiv.innerHTML = '<i class="fas fa-times-circle" style="margin-right: 5px;"></i>Environment: Restricted<br><small>Use Local Server</small>';
                    statusDiv.style.background = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.style.borderColor = '#f5c6cb';
                }
                
                adminProfile.style.position = 'relative';
                adminProfile.appendChild(statusDiv);
                
                // Remove status after 5 seconds
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.parentNode.removeChild(statusDiv);
                    }
                }, 5000);
            }
        }

        // Handle foreground messages
        onMessage(messaging, (payload) => {
            console.log('Admin foreground message received:', payload);
            
            // Only handle messages if FCM is supported in current environment
            if (!checkFCMSupport()) {
                console.log('FCM not supported in current environment, skipping message handling');
                return;
            }
            
            // Show notification using Notification API
            if (Notification.permission === 'granted') {
                const notification = new Notification(payload.notification?.title || 'New Admin Message', {
                    body: payload.notification?.body || 'You have a new admin message',
                    icon: payload.notification?.icon || '/favicon.ico',
                    badge: '/favicon.ico',
                    tag: 'admin-fcm-notification'
                });
                
                // Auto-close notification after 5 seconds
                setTimeout(() => {
                    notification.close();
                }, 5000);
            }
        });

        // Register service worker inline with Blob
        async function registerServiceWorker() {
            try {
                // Check if service worker is supported
                if (!('serviceWorker' in navigator)) {
                    console.log('Service Worker not supported in this browser');
                    return null;
                }

                // Check if we're running on a supported protocol (https or localhost)
                if (window.location.protocol === 'file:' || window.location.protocol === 'null') {
                    console.log('Service Worker cannot be registered on file:// protocol. Please use a local server or HTTPS.');
                    return null;
                }

                // For localhost development, try to register the Firebase messaging service worker
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    try {
                        // First try to register the actual Firebase messaging service worker file
                        const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js', {
                            scope: '/firebase-cloud-messaging-push-scope'
                        });
                        console.log('Firebase Messaging Service Worker registered successfully for localhost:', registration);
                        return registration;
                    } catch (localhostError) {
                        console.log('Failed to register Firebase messaging service worker for localhost:', localhostError);
                        
                        // Fallback to minimal service worker if the file doesn't exist
                        try {
                            const minimalServiceWorkerCode = `
                                // Minimal Service Worker for Localhost Development
                                self.addEventListener('install', (event) => {
                                    console.log('Service Worker installing...');
                                    self.skipWaiting();
                                });

                                self.addEventListener('activate', (event) => {
                                    console.log('Service Worker activating...');
                                    event.waitUntil(self.clients.claim());
                                });

                                self.addEventListener('message', (event) => {
                                    console.log('Service Worker message received:', event.data);
                                });
                            `;

                            const blob = new Blob([minimalServiceWorkerCode], { type: 'application/javascript' });
                            const serviceWorkerUrl = URL.createObjectURL(blob);

                            const fallbackRegistration = await navigator.serviceWorker.register(serviceWorkerUrl);
                            console.log('Minimal Service Worker registered successfully for localhost (fallback):', fallbackRegistration);

                            // Clean up the Blob URL
                            URL.revokeObjectURL(serviceWorkerUrl);

                            return fallbackRegistration;
                        } catch (fallbackError) {
                            console.log('Failed to register fallback service worker for localhost:', fallbackError);
                            return null;
                        }
                    }
                }

                // For production HTTPS, try to register the full Firebase service worker
                if (window.location.protocol === 'https:') {
                    try {
                        // Create service worker code as a Blob
                        const serviceWorkerCode = `
                            // Firebase Cloud Messaging Service Worker
                            importScripts('https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js');
                            importScripts('https://www.gstatic.com/firebasejs/9.6.10/firebase-messaging-compat.js');

                            // Firebase configuration
                            const firebaseConfig = {
                                apiKey: 'AIzaSyBGh16sYlLk1e9nkhcLu7IPTZk807qeLZM',
                                authDomain: 'test-60bf6.firebaseapp.com',
                                databaseURL: 'https://test-60bf6-default-rtdb.firebaseio.com',
                                projectId: 'test-60bf6',
                                storageBucket: 'test-60bf6.firebasestorage.app',
                                messagingSenderId: '208881094528',
                                appId: '1:208881094528:web:114768e2de5956cae6fb65'
                            };

                            // Initialize Firebase
                            firebase.initializeApp(firebaseConfig);
                            const messaging = firebase.messaging();

                            // Handle background messages
                            messaging.onBackgroundMessage((payload) => {
                                console.log('Background message received:', payload);

                                const notificationTitle = payload.notification?.title || 'New Message';
                                const notificationOptions = {
                                    body: payload.notification?.body || 'You have a new message',
                                    icon: payload.notification?.icon || '/favicon.ico',
                                    badge: '/favicon.ico',
                                    tag: 'fcm-background-notification',
                                    data: payload.data || {}
                                };

                                return self.registration.showNotification(notificationTitle, notificationOptions);
                            });

                            // Handle notification click
                            self.addEventListener('notificationclick', (event) => {
                                console.log('Notification clicked:', event);
                                event.notification.close();
                                
                                // Focus on the admin panel if it's open
                                event.waitUntil(
                                    clients.matchAll({ type: 'window' }).then((clientList) => {
                                        for (const client of clientList) {
                                            if (client.url.includes('admin.html') && 'focus' in client) {
                                                return client.focus();
                                            }
                                        }
                                        if (clients.openWindow) {
                                            return clients.openWindow('/admin.html');
                                        }
                                    })
                                );
                            });
                        `;

                        const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
                        const serviceWorkerUrl = URL.createObjectURL(blob);

                        const registration = await navigator.serviceWorker.register(serviceWorkerUrl);
                        console.log('Firebase Service Worker registered successfully:', registration);

                        // Clean up the Blob URL
                        URL.revokeObjectURL(serviceWorkerUrl);

                        return registration;
                    } catch (httpsError) {
                        console.log('Failed to register Firebase service worker for HTTPS:', httpsError);
                        return null;
                    }
                }

                return null;
            } catch (error) {
                console.error('Error registering service worker:', error);
                return null;
            }
        }

        // Connection status indicator
        function updateConnectionStatus(connected) {
            const adminShieldIcon = document.getElementById('admin-shield-icon');
            
            if (adminShieldIcon) {
                if (connected) {
                    adminShieldIcon.style.color = '#28a745'; // Green for connected
                    adminShieldIcon.title = 'Connected to Firebase';
                } else {
                    adminShieldIcon.style.color = '#dc3545'; // Red for disconnected
                    adminShieldIcon.title = 'Disconnected from Firebase';
                }
            }
        }

        // --- Skeleton Loading Functions ---
        function showTableSkeleton(container, title, buttonText, rowCount = 5) {
            container.innerHTML = `
                <div class="skeleton-table">
                    <div class="skeleton-table-header">
                        <div class="skeleton skeleton-table-title"></div>
                        <div class="skeleton skeleton-table-button"></div>
                    </div>
                    ${Array(rowCount).fill(0).map(() => `
                        <div class="skeleton-table-row">
                            <div class="skeleton skeleton-table-image"></div>
                            <div class="skeleton skeleton-table-text"></div>
                            <div class="skeleton skeleton-table-text short"></div>
                            <div class="skeleton skeleton-table-text short"></div>
                            <div class="skeleton skeleton-table-actions"></div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showStatsSkeleton() {
            const statsContainer = document.getElementById('stats-cards');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
            
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div class="skeleton-stats-card">
                        <div class="skeleton skeleton-stats-icon"></div>
                        <div class="skeleton skeleton-stats-number"></div>
                        <div class="skeleton skeleton-stats-label"></div>
                    </div>
                    <div class="skeleton-stats-card">
                        <div class="skeleton skeleton-stats-icon"></div>
                        <div class="skeleton skeleton-stats-number"></div>
                        <div class="skeleton skeleton-stats-label"></div>
                    </div>
                    <div class="skeleton-stats-card">
                        <div class="skeleton skeleton-stats-icon"></div>
                        <div class="skeleton skeleton-stats-number"></div>
                        <div class="skeleton skeleton-stats-label"></div>
                    </div>
                `;
            }
        }



        // --- Enhanced Image Loading for Admin ---
        function loadAdminImageWithFallback(imgElement, src, fallbackSrc = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0yNSAyNUgxNVYxNUgyNVYyNVoiIGZpbGw9IiNDQ0NDQ0MiLz4KPC9zdmc+') {
            return new Promise((resolve) => {
                const img = new Image();
                
                // Add loading class
                imgElement.classList.add('admin-image-loading');
                
                img.onload = () => {
                    imgElement.src = src;
                    imgElement.classList.remove('admin-image-loading');
                    imgElement.classList.add('admin-image-loaded');
                    resolve();
                };
                
                img.onerror = () => {
                    imgElement.src = fallbackSrc;
                    imgElement.classList.remove('admin-image-loading');
                    imgElement.classList.add('admin-image-loaded');
                    resolve(); // Still resolve to continue
                };
                
                img.src = src;
            });
        }

        const adminContent = document.getElementById('admin-content');
        const adminContentWrapper = document.getElementById('admin-content-wrapper');



        // --- Admin Authentication (Re-enabled) ---
        const adminAuthModal = document.getElementById('admin-auth-modal');
        const adminAuthForm = document.getElementById('admin-auth-form');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminAuthError = document.getElementById('admin-auth-error');
        const adminLoginBtn = document.getElementById('admin-login-btn'); // Get the login button

        function showAdminAuthError(message) {
            adminAuthError.textContent = message;
            adminAuthError.style.display = 'block';
        }

        function hideAdminAuthError() {
            adminAuthError.textContent = '';
            adminAuthError.style.display = 'none';
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in, hide login modal and show admin content
                adminAuthModal.style.display = 'none';
                adminContent.style.display = 'block';
                adminContentWrapper.classList.remove('blur-overlay');

                // Initialize FCM and register service worker for admin
                try {
                    await initializeAdminFCM();
                    
                    // Try to register service worker (may fail on file:// protocol)
                    try {
                        const swRegistration = await registerServiceWorker();
                        if (swRegistration) {
                            console.log('Service Worker registered successfully');
                        } else {
                            console.log('Service Worker registration skipped (not supported in current environment)');
                            // Show message about protocol issue
                            if (window.location.protocol === 'file:' || window.location.protocol === 'null') {
                                showProtocolWarning();
                            }
                        }
                    } catch (swError) {
                        console.log('Service Worker registration failed:', swError.message);
                        // Continue without service worker - FCM will still work for foreground messages
                    }
                    
                    // Update notification UI
                    updateNotificationUI();
                    
                    // Setup notification event listeners
                    setupNotificationEventListeners();
                    
                    // Show environment status
                    showEnvironmentStatus();
                    
                    // Load notifications after FCM initialization
                    setTimeout(() => {
                        loadNotifications();
                    }, 1000);
                } catch (error) {
                    console.error('Error initializing admin FCM:', error);
                    // Still update UI even if FCM fails
                    updateNotificationUI();
                    
                    // Show protocol warning if on file:// protocol
                    if (window.location.protocol === 'file:' || window.location.protocol === 'null') {
                        showProtocolWarning();
                    }
                }

                // Trigger initial stats fetch if on today-orders
                if (window.location.hash === '#today-orders') {
                    // No dashboard stats needed
                }
            } else {
                // User is signed out, show login modal and hide admin content
                adminAuthModal.style.display = 'flex';
                adminContent.style.display = 'none';
                adminContentWrapper.classList.add('blur-overlay');
            }
        });

        adminAuthForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAdminAuthError();

            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;

            adminLoginBtn.disabled = true; // Disable button
            adminLoginBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 5px;"></i>Logging in...'; // Show loading indicator

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Login successful, onAuthStateChanged will handle UI update
            } catch (error) {
                showAdminAuthError(error.message);
            } finally {
                adminLoginBtn.disabled = false; // Re-enable button
                adminLoginBtn.innerHTML = '<i class="fas fa-sign-in-alt" style="margin-right: 5px;"></i>Login'; // Restore original text
            }
        });

        function handleAdminLogout() {
            signOut(auth).then(() => {
                // Sign-out successful, onAuthStateChanged will handle UI update
                window.location.hash = '#today-orders'; // Redirect to today orders after logout
                document.body.classList.remove('sidebar-open-mobile'); // Ensure body overflow is reset
                sidebarBackdrop.classList.remove('active'); // Hide backdrop
            }).catch((error) => {
                console.error("Logout Error:", error);
                // Logout failed - no alert needed
            });
        }


        // Time period button functionality
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('time-btn')) {
                // Remove active class from all buttons in the same group
                const buttonGroup = e.target.closest('div');
                buttonGroup.querySelectorAll('.time-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                // Add active class to clicked button
                e.target.classList.add('active');
                
                // Get the selected period and filter orders
                const selectedPeriod = e.target.getAttribute('data-period');
                filterOrdersByPeriod(selectedPeriod);
            }
        });

        // Filter orders by time period
        function filterOrdersByPeriod(period) {
            if (!database) return;
            
            const ordersRef = ref(database, 'orders');
            onValue(ordersRef, (snapshot) => {
                const orders = snapshot.val();
                if (orders) {
                    const filteredOrders = filterOrders(orders, period);
                    renderOrderTable(filteredOrders);
                }
            });
        }

        // Filter orders based on time period
        function filterOrders(orders, period) {
            const now = new Date();
            const filtered = {};
            
            Object.keys(orders).forEach(orderId => {
                const order = orders[orderId];
                const orderDate = new Date(order.timestamp || order.orderDate || now);
                
                let shouldInclude = false;
                
                switch (period) {
                    case 'daily':
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        shouldInclude = orderDate >= today;
                        break;
                    case 'weekly':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        shouldInclude = orderDate >= weekAgo;
                        break;
                    case 'monthly':
                        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                        shouldInclude = orderDate >= monthAgo;
                        break;
                    default:
                        shouldInclude = true;
                }
                
                if (shouldInclude) {
                    filtered[orderId] = order;
                }
            });
            
            return filtered;
        }

        // --- SPA Routing Logic ---
        const adminRoutes = {
            '#dashboard': 'dashboard',
            '#products': 'products',
            '#orders': 'orders',
            '#today-orders': 'today-orders',
            '#slider': 'slider',
            '#messages': 'messages',
            '#logout': 'logout' // Special case for logout
        };

        function showAdminSection(sectionId) {
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }
        }

        function handleAdminHashChange() {
            const hash = window.location.hash || '#today-orders';
            const route = adminRoutes[hash];

            // Ensure bottom navigation is always visible
            const bottomNav = document.querySelector('.admin-bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
                bottomNav.style.zIndex = '9999';
            }

            // Update bottom navigation
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.classList.remove('active');
            });

            if (route) {
                if (route === 'logout') {
                    handleAdminLogout();
                    return;
                }
                showAdminSection(route);
                const activeNavItem = document.querySelector(`.admin-nav-item[data-route="${route}"]`);
                if (activeNavItem) {
                    activeNavItem.classList.add('active');
                }
            } else {
                window.location.hash = '#today-orders';
            }
        }

        window.addEventListener('hashchange', handleAdminHashChange);
        window.addEventListener('load', handleAdminHashChange);



        // --- Dashboard Stats ---
        const totalProductsSpan = document.getElementById('total-products');
        const totalOrdersSpan = document.getElementById('total-orders');
        const totalMessagesSpan = document.getElementById('total-messages');

        

        

        // Handle navigation changes
        window.addEventListener('hashchange', () => {
            if (window.location.hash === '#today-orders') {
                renderTodayOrders();
            }
        });

        // Handle hash changes for navigation
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.substring(1); // Remove the #
            if (hash) {
                showSection(hash);
                
                // Load specific content based on section
                if (hash === 'today-orders') {
                    renderTodayOrders();
                } else if (hash === 'products') {
                    // Products will be loaded automatically via Firebase listener
                } else if (hash === 'orders') {
                    // Load all orders when navigating to orders section
                    onValue(ref(database, 'orders'), (snapshot) => {
                        const allOrders = snapshot.val() || {};
                        renderOrderTable(allOrders);
                    }, { onlyOnce: true });
                } else if (hash === 'slider') {
                    // Slider will be loaded automatically via Firebase listener
                } else if (hash === 'messages') {
                    // Messages will be loaded automatically via Firebase listener
                }
            }
        });

        // Initial load - show correct section by default
        window.addEventListener('load', () => {
            // Ensure bottom navigation is always visible
            const bottomNav = document.querySelector('.admin-bottom-nav');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
                bottomNav.style.zIndex = '9999';
            }

            // Show today's orders by default if no hash
            if (!window.location.hash) {
                showSection('today-orders');
                setTimeout(() => {
                    renderTodayOrders();
                }, 100);
            } else {
                // Show the section based on current hash
                const hash = window.location.hash.substring(1);
                showSection(hash);
                
                if (hash === 'today-orders') {
                    setTimeout(() => {
                        renderTodayOrders();
                    }, 100);
                } else if (hash === 'orders') {
                    setTimeout(() => {
                        onValue(ref(database, 'orders'), (snapshot) => {
                            const allOrders = snapshot.val() || {};
                            renderOrderTable(allOrders);
                        }, { onlyOnce: true });
                    }, 100);
                }
            }
        });

        // Monitor Firebase connection status
        if (database) {
            const connectedRef = ref(database, '.info/connected');
            onValue(connectedRef, (snapshot) => {
                updateConnectionStatus(snapshot.val());
            });
        } else {
            updateConnectionStatus(false);
        }

        // Notification Panel Functions
        function toggleNotificationPanel() {
            const panel = document.getElementById('notification-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                loadNotifications();
            } else {
                panel.style.display = 'none';
            }
        }

        // Close notification panel when clicking outside
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('notification-panel');
            const icon = document.getElementById('notification-icon');
            if (panel && !panel.contains(e.target) && !icon.contains(e.target)) {
                panel.style.display = 'none';
            }
        });

        async function loadNotifications() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                const adminNotificationRef = ref(database, `adminNotifications/${user.uid}`);
                onValue(adminNotificationRef, (snapshot) => {
                    const notifications = snapshot.val() || {};
                    renderNotifications(notifications);
                    updateNotificationBadge(notifications);
                });
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Initialize notifications when admin content is shown
        function initializeNotifications() {
            const user = auth.currentUser;
            if (user) {
                loadNotifications();
            }
        }

        // Add event listeners for notification elements
        function setupNotificationEventListeners() {
            const notificationIcon = document.getElementById('notification-icon');
            if (notificationIcon) {
                notificationIcon.addEventListener('click', toggleNotificationPanel);
            }
            
            // Add event listener for clear all notifications button
            const clearAllBtn = document.getElementById('clear-all-notifications-btn');
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', clearAllNotifications);
            }
            
            // Add event listener for enable notifications button
            const enableNotificationsBtn = document.getElementById('enable-notifications-btn');
            if (enableNotificationsBtn) {
                enableNotificationsBtn.addEventListener('click', requestNotificationPermission);
            }
            
            // Add event listener for add grocery products button
            const addGroceryBtn = document.getElementById('add-grocery-btn');
            if (addGroceryBtn) {
                addGroceryBtn.addEventListener('click', addGroceryProducts);
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            if (Object.keys(notifications).length === 0) {
                notificationList.innerHTML = '<p style="text-align: center; color: var(--muted-color); padding: 20px;">No notifications</p>';
                return;
            }

            let notificationsHtml = '';
            const sortedNotifications = Object.values(notifications).sort((a, b) => b.timestamp - a.timestamp);

            sortedNotifications.forEach(notification => {
                const timeAgo = getTimeAgo(notification.timestamp);
                const isRead = notification.read ? 'opacity: 0.6;' : 'opacity: 1;';
                
                notificationsHtml += `
                    <div class="notification-item" style="padding: 12px; border-bottom: 1px solid var(--border-color); ${isRead}; cursor: pointer;" data-notification-id="${notification.id}" data-notification-type="${notification.type}" data-order-id="${notification.orderData?.orderId || ''}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <h5 style="margin: 0; color: var(--text-color); font-size: 0.9rem; font-weight: 600;">${notification.title}</h5>
                            <span style="font-size: 0.7rem; color: var(--muted-color);">${timeAgo}</span>
                        </div>
                        <p style="margin: 0; color: var(--muted-color); font-size: 0.8rem; line-height: 1.4;">${notification.body}</p>
                        ${notification.type === 'new_order' ? `
                            <div style="margin-top: 8px;">
                                <span style="color: var(--primary-red); font-size: 0.8rem; font-weight: 500;">Click to view order details</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            notificationList.innerHTML = notificationsHtml;
            
            // Add event listeners to notification items
            const notificationItems = notificationList.querySelectorAll('.notification-item');
            notificationItems.forEach(item => {
                item.addEventListener('click', async () => {
                    const notificationId = item.getAttribute('data-notification-id');
                    const type = item.getAttribute('data-notification-type');
                    const orderId = item.getAttribute('data-order-id');
                    
                    await handleNotificationClick(notificationId, type, orderId);
                });
            });
        }

        function updateNotificationBadge(notifications) {
            const badge = document.getElementById('notification-badge');
            if (!badge) return;

            const unreadCount = Object.values(notifications).filter(n => !n.read).length;
            if (unreadCount > 0) {
                badge.style.display = 'flex';
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            } else {
                badge.style.display = 'none';
            }
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        async function clearAllNotifications() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                const adminNotificationRef = ref(database, `adminNotifications/${user.uid}`);
                await set(adminNotificationRef, {});
                
                const notificationList = document.getElementById('notification-list');
                if (notificationList) {
                    notificationList.innerHTML = '<p style="text-align: center; color: var(--muted-color); padding: 20px;">No notifications</p>';
                }
                
                const badge = document.getElementById('notification-badge');
                if (badge) {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error clearing notifications:', error);
            }
        }

        function viewOrderDetails(orderId) {
            // Navigate to orders section and show order details
            window.location.hash = '#orders';
            // You can implement order detail viewing logic here
        }

        // Mark notification as read when clicked
        async function markNotificationAsRead(notificationId) {
            try {
                const user = auth.currentUser;
                if (!user) return;

                const notificationRef = ref(database, `adminNotifications/${user.uid}/${notificationId}`);
                await update(notificationRef, { read: true });
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Handle notification click
        async function handleNotificationClick(notificationId, type, orderId) {
            // Mark notification as read
            await markNotificationAsRead(notificationId);
            
            // Handle different notification types
            if (type === 'new_order' && orderId) {
                viewOrderDetails(orderId);
            }
            
            // Close notification panel
            document.getElementById('notification-panel').style.display = 'none';
        }

        // Functions are now used with event listeners instead of global scope



        // --- Stat Card Click Handlers ---
        document.addEventListener('DOMContentLoaded', () => {
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach(card => {
                card.addEventListener('click', () => {
                    const redirectUrl = card.dataset.redirect;
                    if (redirectUrl) {
                        window.location.hash = redirectUrl;
                    }
                });
            });

            // --- Bottom Navigation Click Handlers ---
            const bottomNavItems = document.querySelectorAll('.admin-nav-item');
            bottomNavItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Get the route from data attribute
                    const route = item.getAttribute('data-route');
                    if (route) {
                        showSection(route);
                        window.location.hash = `#${route}`;
                    }
                });
            });

            // --- Modal Event Listeners ---
            // Order details modal
            const orderDetailsModal = document.getElementById('order-details-modal');
            if (orderDetailsModal) {
                orderDetailsModal.addEventListener('click', function(e) {
                    if (e.target === orderDetailsModal) {
                        orderDetailsModal.style.display = 'none';
                    }
                    
                    // Handle order status button clicks
                    if (e.target.classList.contains('order-status-btn')) {
                        const userId = e.target.getAttribute('data-user-id');
                        const orderId = e.target.getAttribute('data-order-id');
                        const newStatus = e.target.getAttribute('data-status');
                        
                        updateOrderStatusFromModal(userId, orderId, newStatus);
                    }
                    
                    // Handle modal close button clicks
                    if (e.target.classList.contains('modal-close-btn')) {
                        orderDetailsModal.style.display = 'none';
                    }
                });
            }
        });


        const forceShowStatsBtn = document.getElementById('force-show-stats-btn');

        // Force show stats button removed as dashboard is no longer needed







        // --- Product Management (CRUD) ---
        const addProductBtn = document.getElementById('add-product-btn');
        const productManageModal = document.getElementById('product-manage-modal');
        const productManageForm = document.getElementById('product-manage-form');
        const productNameInput = document.getElementById('product-name');
        const productCategoryInput = document.getElementById('product-category');
        const productPriceInput = document.getElementById('product-price');
        const productImageUrlInput = document.getElementById('product-image-url');
        const productDescriptionTextarea = document.getElementById('product-description');

        let editingProductId = null; // To store the ID of the product being edited

        // Add grocery products from Zepto
        const groceryProducts = [
            // Fruits & Vegetables
            { name: "Fresh Apples", price: 120, imageUrl: "https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh and juicy apples, perfect for healthy snacking.", category: "Fruits & Vegetables" },
            { name: "Organic Bananas", price: 60, imageUrl: "https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Organic bananas, rich in potassium and natural sweetness.", category: "Fruits & Vegetables" },
            { name: "Fresh Strawberries", price: 180, imageUrl: "https://images.unsplash.com/photo-1464965911861-746a04b4bca6?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Sweet and juicy strawberries, perfect for desserts.", category: "Fruits & Vegetables" },
            { name: "Fresh Pomegranate", price: 140, imageUrl: "https://images.unsplash.com/photo-1541344999737-9c6c2c7e1a3b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh pomegranate seeds, rich in antioxidants.", category: "Fruits & Vegetables" },
            { name: "Fresh Beetroot", price: 80, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh beetroot, perfect for salads and juices.", category: "Fruits & Vegetables" },
            { name: "Fresh Ash Gourd", price: 45, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh ash gourd, great for cooking and health benefits.", category: "Fruits & Vegetables" },
            { name: "Fresh Bottle Gourd", price: 35, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh bottle gourd, excellent for weight loss.", category: "Fruits & Vegetables" },
            { name: "Fresh Lady Finger", price: 60, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh lady finger, perfect for curries and stir-fries.", category: "Fruits & Vegetables" },
            { name: "Fresh Potatoes", price: 40, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh potatoes, versatile for various dishes.", category: "Fruits & Vegetables" },
            { name: "Fresh Lemons", price: 50, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh lemons, great for cooking and beverages.", category: "Fruits & Vegetables" },
            { name: "Fresh Blueberries", price: 220, imageUrl: "https://images.unsplash.com/photo-1498557850523-fd3d118b962e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh blueberries, rich in antioxidants and vitamins.", category: "Fruits & Vegetables" },
            { name: "Fresh Papaya", price: 90, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh papaya, great for digestion and health.", category: "Fruits & Vegetables" },
            { name: "Fresh Dragon Fruit", price: 150, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh dragon fruit, exotic and nutritious.", category: "Fruits & Vegetables" },
            { name: "Fresh Mushroom", price: 120, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh mushrooms, perfect for cooking and health.", category: "Fruits & Vegetables" },
            { name: "Fresh Lettuce", price: 70, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh lettuce, perfect for salads and sandwiches.", category: "Fruits & Vegetables" },
            { name: "Fresh Avocado", price: 200, imageUrl: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh avocado, rich in healthy fats and nutrients.", category: "Fruits & Vegetables" },
            // Dairy & Bread
            { name: "Amul Butter", price: 55, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh Amul butter, perfect for cooking and spreading.", category: "Dairy & Bread" },
            { name: "Cheese Slices", price: 120, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh cheese slices, great for sandwiches and burgers.", category: "Dairy & Bread" },
            { name: "Fresh Milk", price: 65, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh milk, rich in calcium and nutrients.", category: "Dairy & Bread" },
            { name: "Fresh Curd", price: 45, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh curd, perfect for raita and lassi.", category: "Dairy & Bread" },
            { name: "Fresh Eggs", price: 80, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh eggs, rich in protein and nutrients.", category: "Dairy & Bread" },
            { name: "Fresh Bread", price: 35, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh bread, perfect for sandwiches and toast.", category: "Dairy & Bread" },
            // Grocery Essentials
            { name: "Aashirvaad Atta", price: 55, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Premium quality wheat flour for rotis and breads.", category: "Grocery Essentials" },
            { name: "Basmati Rice", price: 120, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Premium basmati rice, long grain and aromatic.", category: "Grocery Essentials" },
            { name: "Refined Oil", price: 140, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Pure refined oil for cooking and frying.", category: "Grocery Essentials" },
            { name: "Toor Dal", price: 85, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh toor dal, perfect for sambhar and dal.", category: "Grocery Essentials" },
            { name: "Masoor Dal", price: 75, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh masoor dal, great for soups and curries.", category: "Grocery Essentials" },
            // Snacks & Beverages
            { name: "Lays Chips", price: 20, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Crunchy Lays chips, perfect for snacking.", category: "Snacks & Beverages" },
            { name: "Kurkure", price: 10, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Spicy Kurkure, great for evening snacks.", category: "Snacks & Beverages" },
            { name: "Apple Juice", price: 45, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh apple juice, rich in vitamins.", category: "Snacks & Beverages" },
            { name: "Chocolate Box", price: 150, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Assorted chocolate box, perfect for gifting.", category: "Snacks & Beverages" },
            { name: "Cold Coffee", price: 80, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Refreshing cold coffee, perfect for summers.", category: "Snacks & Beverages" },
            // Spices & Masala
            { name: "Dalchini (Cinnamon)", price: 25, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh dalchini for aromatic cooking.", category: "Spices & Masala" },
            { name: "Fennel Seeds", price: 30, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh fennel seeds for mouth freshener.", category: "Spices & Masala" },
            { name: "Turmeric Powder", price: 40, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Pure turmeric powder for cooking.", category: "Spices & Masala" },
            { name: "Red Chili Powder", price: 35, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Spicy red chili powder for heat.", category: "Spices & Masala" },
            { name: "Garam Masala", price: 45, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Aromatic garam masala blend.", category: "Spices & Masala" },
            // Personal Care
            { name: "Toothpaste", price: 65, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Fresh mint toothpaste for oral hygiene.", category: "Personal Care" },
            { name: "Soap", price: 35, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Gentle soap for daily use.", category: "Personal Care" },
            { name: "Shampoo", price: 85, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Nourishing shampoo for healthy hair.", category: "Personal Care" },
            // Household Items
            { name: "Detergent Powder", price: 120, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Powerful detergent for clean clothes.", category: "Household Items" },
            { name: "Dish Soap", price: 55, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Effective dish soap for clean utensils.", category: "Household Items" },
            { name: "Toilet Paper", price: 75, imageUrl: "https://images.unsplash.com/photo-1548907040-4baa7e7d0b19?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=400&q=80", description: "Soft toilet paper for comfort.", category: "Household Items" }
        ];

        // Function to add all grocery products to database
        async function addGroceryProducts() {
            try {
                const productsRef = ref(database, 'products');
                let addedCount = 0;
                
                for (const product of groceryProducts) {
                    const newProductRef = push(productsRef);
                    await set(newProductRef, product);
                    addedCount++;
                }
                
                // Products added successfully - no alert needed
                fetchProducts(); // Refresh product list
            } catch (error) {
                console.error("Error adding grocery products:", error);
                // Error adding products - no alert needed
            }
        }

        function renderProductTable(products) {
            const productTableContainer = document.getElementById('product-table-container');
            if (Object.keys(products).length === 0) {
                productTableContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">No products to display.</p>';
                return;
            }

            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="padding: 10px;">Image</th>
                            <th style="padding: 10px;">Name</th>
                            <th style="padding: 10px;">Category</th>
                            <th style="padding: 10px;">Price</th>
                            <th style="padding: 10px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const productId in products) {
                const product = products[productId];
                tableHtml += `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td data-label="Image:" style="padding: 10px;"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='50' height='50'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3C/svg%3E" alt="${product.name}" class="admin-product-image" data-src="${product.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0yNSAyNUgxNVYxNUgyNVYyNVoiIGZpbGw9IiNDQ0NDQ0MiLz4KPC9zdmc+'}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;"></td>
                        <td data-label="Name:" style="padding: 10px;">${product.name}</td>
                        <td data-label="Category:" style="padding: 10px;">${product.category}</td>
                        <td data-label="Price:" style="padding: 10px;">₹${product.price.toFixed(2)}</td>
                        <td data-label="Actions:" style="padding: 10px; text-align: center;">
                            <button class="icon-btn edit-product-btn" data-product-id="${productId}" style="color: #007bff;"><i class="fas fa-edit"></i></button>
                            <button class="icon-btn delete-product-btn" data-product-id="${productId}" style="color: var(--primary-red); margin-left: 5px;"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }

            tableHtml += `
                    </tbody>
                </table>
            `;
            productTableContainer.innerHTML = tableHtml;

            // Load images with enhanced loading
            productTableContainer.querySelectorAll('.admin-product-image').forEach(img => {
                const imageSrc = img.getAttribute('data-src');
                if (imageSrc) {
                    loadAdminImageWithFallback(img, imageSrc);
                }
            });

                    // Add event listeners for edit and delete buttons
        productTableContainer.querySelectorAll('.edit-product-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                openEditProductModal(e.currentTarget.dataset.productId, products[e.currentTarget.dataset.productId]);
            });
        });

        productTableContainer.querySelectorAll('.delete-product-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                deleteProduct(e.currentTarget.dataset.productId);
            });
        });
        }

        addProductBtn.addEventListener('click', () => {
            editingProductId = null;
            productManageForm.reset();
            productManageModal.style.display = 'flex';
        });

        function openEditProductModal(productId, product) {
            editingProductId = productId;
            productNameInput.value = product.name;
            productCategoryInput.value = product.category;
            productPriceInput.value = product.price;
            productImageUrlInput.value = product.imageUrl;
            productDescriptionTextarea.value = product.description;
            productManageModal.style.display = 'flex';
        }

        productManageForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const productData = {
                name: productNameInput.value,
                category: productCategoryInput.value,
                price: parseFloat(productPriceInput.value),
                imageUrl: productImageUrlInput.value,
                description: productDescriptionTextarea.value,
            };

            const productsRef = ref(database, 'products');

            if (editingProductId) {
                // Update existing product
                const productRef = ref(database, `products/${editingProductId}`);
                await update(productRef, productData);
            } else {
                // Add new product
                const newProductRef = push(productsRef);
                await set(newProductRef, productData);
            }
            productManageModal.style.display = 'none';
            productManageForm.reset();
        });

        async function deleteProduct(productId) {
            // Product deletion confirmed - no confirm dialog needed
                const productRef = ref(database, `products/${productId}`);
                await remove(productRef);
        }

        // Show skeleton loading initially for products
        const productTableContainer = document.getElementById('product-table-container');
        if (productTableContainer) {
            showTableSkeleton(productTableContainer, 'Products', 'Add Product', 6);
        }

        // Listen for product changes to re-render the table
        onValue(ref(database, 'products'), (snapshot) => {
            const products = snapshot.val() || {};
            renderProductTable(products);
        });

        // Refresh product table when navigating to the products section
        window.addEventListener('hashchange', () => {
            if (window.location.hash === '#products') {
                onValue(ref(database, 'products'), (snapshot) => {
                    const products = snapshot.val() || {};
                    renderProductTable(products);
                }, { onlyOnce: true });
            }
        });

        // --- Order Management ---
        const orderTableContainer = document.getElementById('order-table-container');
        const orderSearchInput = document.getElementById('order-search-input');
        const orderSearchBtn = document.getElementById('order-search-btn');
        const orderClearSearchBtn = document.getElementById('order-clear-search-btn');
        const searchResultsInfo = document.getElementById('search-results-info');
        
        let allOrders = {}; // Store all orders for search functionality
        let filteredOrders = {}; // Store filtered orders

        function renderOrderProducts(items) {
            if (!items || !Array.isArray(items) || items.length === 0) {
                return '<span style="color: var(--muted-color); font-size: 0.85rem;">No items</span>';
            }
            
            let productsHtml = '';
            items.forEach((item, index) => {
                const imageUrl = item.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yMCAyNEMyMi4wOTExIDI0IDI0IDIyLjA5MTEgMjQgMjBDMjQgMTcuOTA4OSAyMi4wOTExIDE2IDIwIDE2QzE3LjkwODkgMTYgMTYgMTcuOTA4OSAxNiAyMEMxNiAyMi4wOTExIDE3LjkwODkgMjQgMjAgMjRaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCAyOEMyNC40MTgzIDI4IDI4IDI0LjQxODMgMjggMjBIMTJDMTIgMjQuNDE4MyAxNS41ODE3IDI4IDIwIDI4WiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K';
                const productName = item.name || 'Unknown Product';
                const quantity = item.qty || 1;
                
                productsHtml += `
                    <div style="display: flex; align-items: center; margin-bottom: ${index < items.length - 1 ? '10px' : '0'}; padding: 4px 0;">
                        <img src="${imageUrl}" alt="${productName}" style="width: 32px; height: 32px; border-radius: 6px; object-fit: cover; margin-right: 10px; flex-shrink: 0; border: 1px solid var(--border-color);">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500; font-size: 0.9rem; color: var(--text-color); line-height: 1.2; margin-bottom: 2px; word-wrap: break-word; max-width: 130px;" title="${productName}">${productName}</div>
                            <div style="font-size: 0.8rem; color: var(--muted-color); font-weight: 500;">Qty: ${quantity}</div>
                        </div>
                    </div>
                `;
            });
            
            return productsHtml;
        }

        function getStatusColor(status) {
            switch(status) {
                case 'Pending': return '#ffc107';
                case 'Processing': return '#17a2b8';
                case 'Shipped': return '#007bff';
                case 'Delivered': return '#28a745';
                case 'Cancelled': return '#dc3545';
                default: return '#6c757d';
            }
        }

        function renderOrderTable(allOrders) {
            if (!allOrders || Object.keys(allOrders).length === 0) {
                orderTableContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">No orders to display.</p>';
                return;
            }
            
            // Store all orders for search functionality
            window.allOrders = allOrders;

            let tableHtml = `
                <div style="display: grid; gap: 15px; padding: 10px; margin-top: 10px;">
            `;

            const ordersArray = [];
            for (const userId in allOrders) {
                for (const orderId in allOrders[userId]) {
                    ordersArray.push({ userId, ...allOrders[userId][orderId] });
                }
            }

            // Sort orders by date (most recent first)
            ordersArray.sort((a, b) => b.date - a.date);

            ordersArray.forEach(order => {
                const orderDate = new Date(order.date).toLocaleDateString();
                const firstProduct = order.items && order.items.length > 0 ? order.items[0] : null;
                const productImage = firstProduct ? (firstProduct.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yMCAyNEMyMi4wOTExIDI0IDI0IDIyLjA5MTEgMjQgMjBDMjQgMTcuOTA4OSAyMi4wOTExIDE2IDIwIDE2QzE3LjkwODkgMTYgMTYgMTcuOTA4OSAxNiAyMEMxNiAyMi4wOTExIDE3LjkwODkgMjQgMjAgMjRaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCAyOEMyNC40MTgzIDI4IDI4IDI0LjQxODMgMjggMjBIMTJDMTIgMjQuNDE4MyAxNS41ODE3IDI4IDIwIDI4WiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K') : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yMCAyNEMyMi4wOTExIDI0IDI0IDIyLjA5MTEgMjQgMjBDMjQgMTcuOTA4OSAyMi4wOTExIDE2IDIwIDE2QzE3LjkwODkgMTYgMTYgMTcuOTA4OSAxNiAyMEMxNiAyMi4wOTExIDE3LjkwODkgMjQgMjAgMjRaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCAyOEMyNC40MTgzIDI4IDI4IDI0LjQxODMgMjggMjBIMTJDMTIgMjQuNDE4MyAxNS41ODE3IDI4IDIwIDI4WiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K';
                const productName = firstProduct ? firstProduct.name : 'No Product';
                const totalItems = order.items ? order.items.length : 0;
                
                tableHtml += `
                    <div class="order-card" data-order='${JSON.stringify(order)}' style="background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="flex-shrink: 0;">
                                <img src="${productImage}" alt="${productName}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border-color);">
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 1rem; color: var(--text-color); margin-bottom: 4px;">${order.shippingName}</div>
                                <div style="font-size: 0.9rem; color: var(--muted-color); margin-bottom: 4px;">📱 ${order.shippingMobile || 'N/A'}</div>
                                <div style="font-size: 0.85rem; color: var(--muted-color); line-height: 1.3; margin-bottom: 6px;">📍 ${order.shippingAddress || 'N/A'}</div>
                                <div style="display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: var(--muted-color);">
                                    <span>📦 ${totalItems} item${totalItems !== 1 ? 's' : ''}</span>
                                    <span>💰 ₹${order.totalAmount.toFixed(2)}</span>
                                    <span>📅 ${orderDate}</span>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
                                <div class="order-status-badge status-${order.status.toLowerCase()}" style="padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; background: ${getStatusColor(order.status)}; color: white; min-width: 70px; text-align: center;">
                                    ${order.status}
                                </div>
                                <button class="update-status-btn" data-user-id="${order.userId}" data-order-id="${order.orderId}" style="background: var(--primary-red); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;">
                                    <i class="fas fa-edit" style="font-size: 14px;"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            tableHtml += `
                </div>
            `;
            orderTableContainer.innerHTML = tableHtml;

            // Add event listeners for order cards (click to view details)
            orderTableContainer.querySelectorAll('.order-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // Don't trigger if clicking on the update status button
                    if (e.target.closest('.update-status-btn')) {
                        return;
                    }
                    const orderData = JSON.parse(card.dataset.order);
                    showOrderDetailsModal(orderData);
                });
            });

            // Add event listeners for update status buttons
            orderTableContainer.querySelectorAll('.update-status-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent card click
                    const userId = button.dataset.userId;
                    const orderId = button.dataset.orderId;
                    showStatusUpdateModal(userId, orderId);
                });
            });
        }

        // Search functionality for orders
        function searchOrders(searchTerm) {
            if (!searchTerm || searchTerm.trim() === '') {
                // If search is empty, show all orders
                renderOrderTable(window.allOrders);
                searchResultsInfo.style.display = 'none';
                return;
            }

            const searchLower = searchTerm.toLowerCase().trim();
            const filteredOrders = {};

            // Search through all orders
            for (const userId in window.allOrders) {
                for (const orderId in window.allOrders[userId]) {
                    const order = window.allOrders[userId][orderId];
                    
                    // Search by Order ID
                    if (orderId.toLowerCase().includes(searchLower)) {
                        if (!filteredOrders[userId]) filteredOrders[userId] = {};
                        filteredOrders[userId][orderId] = order;
                        continue;
                    }
                    
                    // Search by Customer Name
                    if (order.shippingName && order.shippingName.toLowerCase().includes(searchLower)) {
                        if (!filteredOrders[userId]) filteredOrders[userId] = {};
                        filteredOrders[userId][orderId] = order;
                        continue;
                    }
                    
                    // Search by Customer Mobile
                    if (order.shippingMobile && order.shippingMobile.includes(searchTerm)) {
                        if (!filteredOrders[userId]) filteredOrders[userId] = {};
                        filteredOrders[userId][orderId] = order;
                        continue;
                    }
                }
            }

            // Show filtered results
            renderOrderTable(filteredOrders);
            
            // Show search results info
            const resultCount = Object.keys(filteredOrders).length > 0 ? 
                Object.values(filteredOrders).reduce((total, userOrders) => total + Object.keys(userOrders).length, 0) : 0;
            
            if (resultCount > 0) {
                searchResultsInfo.innerHTML = `<i class="fas fa-check-circle" style="color: #28a745; margin-right: 5px;"></i>Found ${resultCount} order(s) matching "${searchTerm}"`;
                searchResultsInfo.style.display = 'block';
            } else {
                searchResultsInfo.innerHTML = `<i class="fas fa-info-circle" style="color: #ffc107; margin-right: 5px;"></i>No orders found matching "${searchTerm}"`;
                searchResultsInfo.style.display = 'block';
            }
        }

        // Add event listeners for search functionality
        if (orderSearchBtn) {
            orderSearchBtn.addEventListener('click', () => {
                const searchTerm = orderSearchInput.value;
                searchOrders(searchTerm);
            });
        }

        if (orderClearSearchBtn) {
            orderClearSearchBtn.addEventListener('click', () => {
                orderSearchInput.value = '';
                searchResultsInfo.style.display = 'none';
                renderOrderTable(window.allOrders);
            });
        }

        // Add enter key support for search input
        if (orderSearchInput) {
            orderSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const searchTerm = orderSearchInput.value;
                    searchOrders(searchTerm);
                }
            });
        }

        async function updateOrderStatus(userId, orderId, newStatus) {
            try {
                const orderRef = ref(database, `orders/${userId}/${orderId}`);
                
                // Get current order data before updating
                const orderSnapshot = await get(ref(database, `orders/${userId}/${orderId}`));
                const orderData = orderSnapshot.val();
                
                // Update the order status
                await update(orderRef, { status: newStatus });
                console.log(`Order ${orderId} status updated to ${newStatus}`);
                
                // Send Telegram notification for status update
                if (orderData) {
                    const updatedOrderData = { ...orderData, status: newStatus };
                    sendTelegramNotification(updatedOrderData, 'status_update');
                }
                
            } catch (error) {
                console.error('Error updating order status:', error);
            }
        }

        async function deleteOrder(userId, orderId) {
            try {
                // Get order data before deleting
                const orderSnapshot = await get(ref(database, `orders/${userId}/${orderId}`));
                const orderData = orderSnapshot.val();
                
                // Order deletion confirmed - no confirm dialog needed
                const orderRef = ref(database, `orders/${userId}/${orderId}`);
                await remove(orderRef);
                console.log(`Order ${orderId} deleted.`);
                
                // Send Telegram notification for order cancellation
                if (orderData) {
                    sendTelegramNotification(orderData, 'order_cancelled');
                }
                
            } catch (error) {
                console.error('Error deleting order:', error);
            }
        }

        // Function to render today's orders
        function renderTodayOrders() {
            const todayOrdersContainer = document.getElementById('today-orders-container');
            if (!todayOrdersContainer) return;

            // Get today's date (start of day)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();

            // Check if database is available
            if (!database) {
                todayOrdersContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">Database not available.</p>';
                return;
            }

            // Show loading state
            todayOrdersContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">Loading today\'s orders...</p>';

            // Listen to orders data
            onValue(ref(database, 'orders'), (snapshot) => {
                const allOrders = snapshot.val();
                if (!allOrders || Object.keys(allOrders).length === 0) {
                    todayOrdersContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">No orders placed today.</p>';
                    return;
                }

                const todayOrders = [];
                const previousOrders = JSON.parse(localStorage.getItem('previousOrders') || '{}');
                const newOrders = [];

                for (const userId in allOrders) {
                    for (const orderId in allOrders[userId]) {
                        const order = allOrders[userId][orderId];
                        const orderDate = new Date(order.date);
                        orderDate.setHours(0, 0, 0, 0);
                        
                        // Check if order was placed today
                        if (orderDate.getTime() === todayTimestamp) {
                            todayOrders.push({ userId, ...order });
                            
                            // Check if this is a new order
                            const orderKey = `${userId}_${orderId}`;
                            if (!previousOrders[orderKey]) {
                                newOrders.push({ userId, ...order });
                                // Send Telegram notification for new order
                                sendTelegramNotification({ userId, ...order }, 'new_order');
                            }
                        }
                    }
                }

                // Update previous orders in localStorage
                const currentOrders = {};
                for (const userId in allOrders) {
                    for (const orderId in allOrders[userId]) {
                        const orderKey = `${userId}_${orderId}`;
                        currentOrders[orderKey] = true;
                    }
                }
                localStorage.setItem('previousOrders', JSON.stringify(currentOrders));

                // Log new orders found
                if (newOrders.length > 0) {
                    console.log(`Found ${newOrders.length} new order(s):`, newOrders);
                }

                if (todayOrders.length === 0) {
                    todayOrdersContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">No orders placed today.</p>';
                    return;
                }

                // Sort orders by time (most recent first)
                todayOrders.sort((a, b) => b.date - a.date);

                let todayOrdersHtml = `
                    <div style="display: grid; gap: 15px; padding: 10px; margin-top: 10px;">
                `;

                todayOrders.forEach(order => {
                    const orderTime = new Date(order.date).toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    });
                    const firstProduct = order.items && order.items.length > 0 ? order.items[0] : null;
                    const productImage = firstProduct ? (firstProduct.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yMCAyNEMyMi4wOTExIDI0IDI0IDIyLjA5MTEgMjQgMjBDMjQgMTcuOTA4OSAyMi4wOTExIDE2IDIwIDE2QzE3LjkwODkgMTYgMTYgMTcuOTA4OSAxNiAyMEMxNiAyMi4wOTExIDE3LjkwODkgMjQgMjAgMjRaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCAyOEMyNC40MTgzIDI4IDI4IDI0LjQxODMgMjggMjBIMTJDMTIgMjQuNDE4MyAxNS41ODE3IDI4IDIwIDI4WiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K') : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0yMCAyNEMyMi4wOTExIDI0IDI0IDIyLjA5MTEgMjQgMjBDMjQgMTcuOTA4OSAyMi4wOTExIDE2IDIwIDE2QzE3LjkwODkgMTYgMTYgMTcuOTA4OSAxNiAyMEMxNiAyMi4wOTExIDE3LjkwODkgMjQgMjAgMjRaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0yMCAyOEMyNC40MTgzIDI4IDI4IDI0LjQxODMgMjggMjBIMTJDMTIgMjQuNDE4MyAxNS41ODE3IDI4IDIwIDI4WiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K';
                    const productName = firstProduct ? firstProduct.name : 'No Product';
                    const totalItems = order.items ? order.items.length : 0;
                    
                    todayOrdersHtml += `
                        <div class="order-card" data-order='${JSON.stringify(order)}' style="background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="flex-shrink: 0;">
                                    <img src="${productImage}" alt="${productName}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border-color);">
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; font-size: 1rem; color: var(--text-color); margin-bottom: 4px;">${order.shippingName}</div>
                                    <div style="font-size: 0.9rem; color: var(--muted-color); margin-bottom: 4px;">📱 ${order.shippingMobile || 'N/A'}</div>
                                    <div style="font-size: 0.85rem; color: var(--muted-color); line-height: 1.3; margin-bottom: 6px;">📍 ${order.shippingAddress || 'N/A'}</div>
                                    <div style="display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: var(--muted-color);">
                                        <span>📦 ${totalItems} item${totalItems !== 1 ? 's' : ''}</span>
                                        <span>💰 ₹${order.totalAmount.toFixed(2)}</span>
                                        <span>🕐 ${orderTime}</span>
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px; align-items: center;">
                                    <div class="order-status-badge status-${order.status.toLowerCase()}" style="padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; background: ${getStatusColor(order.status)}; color: white; min-width: 70px; text-align: center;">
                                        ${order.status}
                                    </div>
                                    <button class="update-status-btn" data-user-id="${order.userId}" data-order-id="${order.orderId}" style="background: var(--primary-red); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease;">
                                        <i class="fas fa-edit" style="font-size: 14px;"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                todayOrdersHtml += `
                    </div>
                `;
                todayOrdersContainer.innerHTML = todayOrdersHtml;

                // Add event listeners for today's order cards (click to view details)
                todayOrdersContainer.querySelectorAll('.order-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        // Don't trigger if clicking on the update status button
                        if (e.target.closest('.update-status-btn')) {
                            return;
                        }
                        const orderData = JSON.parse(card.dataset.order);
                        showOrderDetailsModal(orderData);
                    });
                });

                // Add event listeners for update status buttons
                todayOrdersContainer.querySelectorAll('.update-status-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent card click
                        const userId = button.dataset.userId;
                        const orderId = button.dataset.orderId;
                        showStatusUpdateModal(userId, orderId);
                    });
                });
            }, (error) => {
                console.error('Error loading today\'s orders:', error);
                todayOrdersContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">Error loading today\'s orders.</p>';
            });
        }

        // Listen for all orders changes to re-render the table
        onValue(ref(database, 'orders'), (snapshot) => {
            const allOrders = snapshot.val() || {};
            renderOrderTable(allOrders);
        });

        // Refresh order table when navigating to the orders section
        window.addEventListener('hashchange', () => {
            if (window.location.hash === '#orders') {
                onValue(ref(database, 'orders'), (snapshot) => {
                    const allOrders = snapshot.val() || {};
                    renderOrderTable(allOrders);
                }, { onlyOnce: true });
            }
        });

        // --- Slider / Ad Management ---
        const addSliderImageBtn = document.getElementById('add-slider-image-btn');
        const addSliderImageModal = document.getElementById('add-slider-image-modal');
        const addSliderImageForm = document.getElementById('add-slider-image-form');
        const sliderImageUrlInput = document.getElementById('slider-image-url-input');
        const sliderImageTableContainer = document.getElementById('slider-image-table-container');

        function renderSliderImageTable(sliderImages) {
            if (Object.keys(sliderImages).length === 0) {
                sliderImageTableContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">No slider images to display.</p>';
                return;
            }

            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="padding: 10px;">Preview</th>
                            <th style="padding: 10px;">URL</th>
                            <th style="padding: 10px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const imageId in sliderImages) {
                const image = sliderImages[imageId];
                tableHtml += `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td data-label="Preview:" style="padding: 10px;"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='60'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3C/svg%3E" alt="Slider Image" class="admin-slider-image" data-src="${image.downloadURL}" style="width: 100px; height: 60px; object-fit: cover; border-radius: 4px;"></td>
                        <td data-label="URL:" style="padding: 10px; word-break: break-all;">${image.downloadURL}</td>
                        <td data-label="Actions:" style="padding: 10px; text-align: center;">
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                <button class="icon-btn edit-slider-image-btn" data-image-id="${imageId}" data-image-url="${image.downloadURL}" style="color: #007bff; background: #f8f9fa; border: 1px solid #dee2e6; padding: 6px 10px; border-radius: 4px;">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="icon-btn delete-slider-image-btn" data-image-id="${imageId}" style="color: white; background: var(--primary-red); border: none; padding: 6px 10px; border-radius: 4px;">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }

            tableHtml += `
                    </tbody>
                </table>
            `;
            sliderImageTableContainer.innerHTML = tableHtml;

            // Load images with enhanced loading
            sliderImageTableContainer.querySelectorAll('.admin-slider-image').forEach(img => {
                const imageSrc = img.getAttribute('data-src');
                if (imageSrc) {
                    loadAdminImageWithFallback(img, imageSrc, 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjYwIiB2aWV3Qm94PSIwIDAgMTAwIDYwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik01MCAzNkM1Mi4wOTExIDM2IDU0IDM0LjA5MTEgNTQgMzJDNTQgMjkuOTA4OSA1Mi4wOTExIDI4IDUwIDI4QzQ3LjkwODkgMjggNDYgMjkuOTA4OSA0NiAzMkM0NiAzNC4wOTExIDQ3LjkwODkgMzYgNTAgMzZaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik01MCA0MEM1NC40MTgzIDQwIDU4IDM2LjQxODMgNTggMzJIMjJDMTIgMzYuNDE4MyAxNS41ODE3IDQwIDIwIDQwWiIgZmlsbD0iI0NDQyIvPgo8L3N2Zz4K');
                }
            });

            // Add event listeners for delete buttons
            const deleteButtons = sliderImageTableContainer.querySelectorAll('.delete-slider-image-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', (e) => deleteSliderImage(e.currentTarget.dataset.imageId));
            });

            // Add event listeners for edit buttons
            const editButtons = sliderImageTableContainer.querySelectorAll('.edit-slider-image-btn');
            editButtons.forEach(button => {
                button.addEventListener('click', (e) => editSliderImage(e.currentTarget.dataset.imageId, e.currentTarget.dataset.imageUrl));
            });
        }

        addSliderImageBtn.addEventListener('click', () => {
            sliderImageUrlInput.value = '';
            addSliderImageModal.style.display = 'flex';
        });

        addSliderImageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const imageUrl = sliderImageUrlInput.value;
            if (imageUrl) {
                const editingImageId = addSliderImageForm.dataset.editingImageId;
                
                if (editingImageId) {
                    // Update existing image
                    const imageRef = ref(database, `sliderImages/${editingImageId}`);
                    await update(imageRef, { downloadURL: imageUrl });
                    delete addSliderImageForm.dataset.editingImageId;
                } else {
                    // Add new image
                    const sliderRef = ref(database, 'sliderImages');
                    const newImageRef = push(sliderRef);
                    await set(newImageRef, { downloadURL: imageUrl });
                }
                
                addSliderImageModal.style.display = 'none';
                addSliderImageForm.reset();
                
                // Reset modal title and button text
                const modalTitle = addSliderImageModal.querySelector('h2');
                const submitBtn = addSliderImageForm.querySelector('button[type="submit"]');
                if (modalTitle) modalTitle.textContent = 'Add New Slider Image';
                if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-plus" style="margin-right: 5px;"></i>Add Image';
            }
        });

        async function deleteSliderImage(imageId) {
            if (confirm("Are you sure you want to delete this slider image?")) {
                const imageRef = ref(database, `sliderImages/${imageId}`);
                await remove(imageRef);
            }
        }

        function editSliderImage(imageId, currentUrl) {
            sliderImageUrlInput.value = currentUrl;
            addSliderImageModal.style.display = 'flex';
            
            // Change modal title and button text for editing
            const modalTitle = addSliderImageModal.querySelector('h2');
            const submitBtn = addSliderImageForm.querySelector('button[type="submit"]');
            
            if (modalTitle) modalTitle.textContent = 'Edit Slider Image';
            if (submitBtn) submitBtn.innerHTML = '<i class="fas fa-save" style="margin-right: 5px;"></i>Update Image';
            
            // Store the editing image ID
            addSliderImageForm.dataset.editingImageId = imageId;
        }

        // Show skeleton loading initially for slider images
        if (sliderImageTableContainer) {
            showTableSkeleton(sliderImageTableContainer, 'Slider Images', 'Add Image', 4);
        }

        // Listen for slider image changes to re-render the table
        onValue(ref(database, 'sliderImages'), (snapshot) => {
            const sliderImages = snapshot.val() || {};
            renderSliderImageTable(sliderImages);
        });

        // Refresh slider image table when navigating to the slider section
        window.addEventListener('hashchange', () => {
            if (window.location.hash === '#slider') {
                onValue(ref(database, 'sliderImages'), (snapshot) => {
                    const sliderImages = snapshot.val() || {};
                    renderSliderImageTable(sliderImages);
                }, { onlyOnce: true });
            }
        });

        // --- Message Management ---
        const messagesTableContainer = document.getElementById('messages-table-container');

        function renderMessagesTable(messages) {
            if (Object.keys(messages).length === 0) {
                messagesTableContainer.innerHTML = '<p style="text-align: center; color: var(--muted-color);">No messages to display.</p>';
                return;
            }

            let tableHtml = `
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="padding: 10px;">Date</th>
                            <th style="padding: 10px;">Sender Name</th>
                            <th style="padding: 10px;">Email</th>
                            <th style="padding: 10px;">Message</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Sort messages by date (most recent first)
            const sortedMessages = Object.values(messages).sort((a, b) => b.date - a.date);

            sortedMessages.forEach((message, index) => {
                const messageDate = new Date(message.date).toLocaleDateString() + ' ' + new Date(message.date).toLocaleTimeString();
                const truncatedMessage = message.message.length > 50 ? message.message.substring(0, 50) + '...' : message.message;
                
                // Store message data in data attributes for safer handling
                const messageId = `msg_${index}_${Date.now()}`;
                
                tableHtml += `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td data-label="Date:" style="padding: 10px;">${messageDate}</td>
                        <td data-label="Sender Name:" style="padding: 10px;">${message.name}</td>
                        <td data-label="Email:" style="padding: 10px;">${message.email}</td>
                        <td data-label="Message:" style="padding: 10px; cursor: pointer; color: var(--primary-red); text-decoration: underline;" 
                            class="message-cell" 
                            data-message-id="${messageId}"
                            data-name="${message.name.replace(/"/g, '&quot;')}" 
                            data-email="${message.email.replace(/"/g, '&quot;')}" 
                            data-date="${messageDate}" 
                            data-message="${message.message.replace(/"/g, '&quot;')}">
                            ${truncatedMessage}
                        </td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;
            messagesTableContainer.innerHTML = tableHtml;
            
            // Add click event listeners to message cells
            const messageCells = messagesTableContainer.querySelectorAll('.message-cell');
            messageCells.forEach(cell => {
                cell.addEventListener('click', function() {
                    const name = this.getAttribute('data-name');
                    const email = this.getAttribute('data-email');
                    const date = this.getAttribute('data-date');
                    const message = this.getAttribute('data-message');
                    showMessageModal(name, email, date, message);
                });
            });
        }

        // Function to show message modal
        function showMessageModal(name, email, date, message) {
            const modal = document.getElementById('message-view-modal');
            const modalContent = document.getElementById('message-modal-content');
            
            modalContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">From:</strong>
                            <div style="font-size: 1.1rem; color: var(--text-color);">${name}</div>
                        </div>
                        <div>
                            <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">Email:</strong>
                            <div style="color: var(--primary-red);">${email}</div>
                        </div>
                        <div>
                            <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">Date:</strong>
                            <div style="color: var(--text-color);">${date}</div>
                        </div>
                    </div>
                    <div>
                        <strong style="color: var(--muted-color); display: block; margin-bottom: 10px;">Message:</strong>
                        <div style="background: var(--surface-dark-color); padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary-red); line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">${message}</div>
                    </div>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            // Close modal when clicking outside the content
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Listen for messages changes to re-render the table
        onValue(ref(database, 'messages'), (snapshot) => {
            const messages = snapshot.val() || {};
            renderMessagesTable(messages);
        });

        // Refresh messages table when navigating to the messages section
        window.addEventListener('hashchange', () => {
            if (window.location.hash === '#messages') {
                onValue(ref(database, 'messages'), (snapshot) => {
                    const messages = snapshot.val() || {};
                    renderMessagesTable(messages);
                }, { onlyOnce: true });
            }
        });




        // Function to show status update modal
        function showStatusUpdateModal(userId, orderId) {
            const modal = document.getElementById('status-update-modal');
            const statusSelect = document.getElementById('status-update-select');
            const updateBtn = document.getElementById('status-update-btn');
            
            // Set current order data
            updateBtn.dataset.userId = userId;
            updateBtn.dataset.orderId = orderId;
            
            // Add event listener for update button
            updateBtn.onclick = async () => {
                const newStatus = statusSelect.value;
                try {
                    await updateOrderStatus(userId, orderId, newStatus);
                    modal.style.display = 'none';
                    // Refresh the orders display
                    renderTodayOrders();
                    // Show success message
                    // Status updated successfully - no alert needed
                } catch (error) {
                    console.error('Error updating order status:', error);
                    // Error updating status - no alert needed
                }
            };
            
            // Show modal
            modal.style.display = 'flex';
        }

        // Function to show/hide sections based on navigation
        function showSection(sectionId) {
            console.log('showSection called with:', sectionId);
            
            // Hide all sections
            const allSections = document.querySelectorAll('.admin-section');
            allSections.forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            
            // Show the selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.classList.add('active');
                console.log('Section shown:', sectionId);
            } else {
                console.error('Section not found:', sectionId);
            }
            
            // Update active navigation item
            const allNavItems = document.querySelectorAll('.admin-nav-item');
            allNavItems.forEach(item => {
                item.classList.remove('active');
            });
            
            const activeNavItem = document.querySelector(`[data-route="${sectionId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
                console.log('Navigation updated for:', sectionId);
            } else {
                console.error('Navigation item not found for:', sectionId);
            }
        }

        // Function to show order details in full screen modal
        function showOrderDetailsModal(order) {
            const modal = document.getElementById('order-details-modal');
            const content = document.getElementById('order-details-content');
            
            const orderDate = new Date(order.date).toLocaleDateString() + ' ' + new Date(order.date).toLocaleTimeString();
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: var(--primary-red); margin-bottom: 10px;">Order Details</h2>
                    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                        <div class="status-badge status-${order.status.toLowerCase()}" style="padding: 10px 20px; font-size: 1rem;">
                            ${order.status}
                        </div>
                        <div style="background: var(--surface-dark-color); padding: 10px 20px; border-radius: 8px;">
                            <strong>Order ID:</strong> ${order.orderId}
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- Customer Information -->
                    <div class="card" style="margin: 0;">
                        <h3 style="color: var(--primary-red); margin-bottom: 20px; display: flex; align-items: center;">
                            <i class="fas fa-user" style="margin-right: 10px;"></i>Customer Information
                        </h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">Name:</strong>
                                <span style="font-size: 1.1rem;">${order.shippingName}</span>
                            </div>
                            <div>
                                <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">Contact & Address:</strong>
                                <div style="margin-bottom: 8px;">
                                    <span style="font-size: 1.1rem; font-family: monospace; color: var(--primary-red); font-weight: 600;">📱 ${order.shippingMobile || 'Not provided'}</span>
                                </div>
                                <div>
                                    <span style="font-size: 1rem; line-height: 1.4; color: var(--text-color);">📍 ${order.shippingAddress || 'Not provided'}</span>
                                </div>
                            </div>

                            <div>
                                <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">Order Date:</strong>
                                <span style="font-size: 1.1rem;">${orderDate}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="card" style="margin: 0;">
                        <h3 style="color: var(--primary-red); margin-bottom: 20px; display: flex; align-items: center;">
                            <i class="fas fa-receipt" style="margin-right: 10px;"></i>Order Summary
                        </h3>
                        <div style="display: grid; gap: 15px;">
                            <div>
                                <strong style="color: var(--muted-color); display: block; margin-bottom: 5px;">Total Amount:</strong>
                                <span style="font-size: 1.5rem; font-weight: 700; color: var(--primary-red);">₹${order.totalAmount.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary-red); margin-bottom: 20px; display: flex; align-items: center;">
                        <i class="fas fa-shopping-cart" style="margin-right: 10px;"></i>Order Items
                    </h3>
                    <div style="display: grid; gap: 15px;">
                        ${order.items.map(item => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--surface-dark-color); border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <img src="${item.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0yNSAyNUgxNVYxNUgyNVYyNVoiIGZpbGw9IiNDQ0NDQ0MiLz4KPC9zdmc+'}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 5px;">${item.name}</div>
                                        <div style="color: var(--muted-color); font-size: 0.9rem;">Quantity: ${item.qty}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 600; color: var(--primary-red);">₹${(item.price * item.qty).toFixed(2)}</div>
                                    <div style="color: var(--muted-color); font-size: 0.9rem;">₹${item.price.toFixed(2)} each</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Order Progress -->
                <div class="card" style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary-red); margin-bottom: 20px; display: flex; align-items: center;">
                        <i class="fas fa-chart-line" style="margin-right: 10px;"></i>Order Progress
                    </h3>
                    <div class="order-progress-bar" style="margin: 20px 0;">
                        <div class="order-progress-step ${getProgressStepClass(order.status, 'Pending')}" data-step="Pending">
                            <div class="progress-step-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <span class="progress-step-label">Pending</span>
                        </div>
                        <div class="order-progress-step ${getProgressStepClass(order.status, 'Processing')}" data-step="Processing">
                            <div class="progress-step-icon">
                                <i class="fas fa-cog"></i>
                            </div>
                            <span class="progress-step-label">Processing</span>
                        </div>
                        <div class="order-progress-step ${getProgressStepClass(order.status, 'Shipped')}" data-step="Shipped">
                            <div class="progress-step-icon">
                                <i class="fas fa-shipping-fast"></i>
                            </div>
                            <span class="progress-step-label">Shipped</span>
                        </div>
                        <div class="order-progress-step ${getProgressStepClass(order.status, 'Delivered')}" data-step="Delivered">
                            <div class="progress-step-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <span class="progress-step-label">Delivered</span>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary-red);">
                            ${getOrderProgressPercentage(order.status)}% Complete
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button class="order-status-btn" data-user-id="${order.userId}" data-order-id="${order.orderId}" data-status="Processing" style="background-color: #007bff; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;">
                        <i class="fas fa-cog" style="margin-right: 8px;"></i>Mark as Processing
                    </button>
                    <button class="order-status-btn" data-user-id="${order.userId}" data-order-id="${order.orderId}" data-status="Shipped" style="background-color: #28a745; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;">
                        <i class="fas fa-shipping-fast" style="margin-right: 8px;"></i>Mark as Shipped
                    </button>
                    <button class="order-status-btn" data-user-id="${order.userId}" data-order-id="${order.orderId}" data-status="Delivered" style="background-color: #17a2b8; color: white; padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer;">
                        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>Mark as Delivered
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // Helper function to update order status from modal
        function updateOrderStatusFromModal(userId, orderId, newStatus) {
            updateOrderStatus(userId, orderId, newStatus);
            // Close modal after status update
            document.getElementById('order-details-modal').style.display = 'none';
        }

        // Functions are now used with event listeners instead of global scope
        
        // Debug: Log function availability
        console.log('Functions available:', {
            handleNotificationClick: typeof handleNotificationClick,
            markNotificationAsRead: typeof markNotificationAsRead,
            requestNotificationPermission: typeof requestNotificationPermission,
            clearAllNotifications: typeof clearAllNotifications,
            addGroceryProducts: typeof addGroceryProducts,
            updateOrderStatusFromModal: typeof updateOrderStatusFromModal
        });

        // Helper functions for order progress
        function getProgressStepClass(currentStatus, stepStatus) {
            const statusOrder = ['Pending', 'Processing', 'Shipped', 'Delivered'];
            const currentIndex = statusOrder.indexOf(currentStatus);
            const stepIndex = statusOrder.indexOf(stepStatus);
            
            if (stepIndex < currentIndex) {
                return 'completed';
            } else if (stepIndex === currentIndex) {
                return 'current';
            } else {
                return '';
            }
        }

        function getOrderProgressPercentage(status) {
            const statusOrder = ['Pending', 'Processing', 'Shipped', 'Delivered'];
            const currentIndex = statusOrder.indexOf(status);
            if (currentIndex === -1) return 0;
            return Math.round(((currentIndex + 1) / statusOrder.length) * 100);
        }

        // --- Notification System ---
        // Notification system completely removed - no more notification functionality
    </script>

    <!-- Fixed Bottom Navigation -->
    <nav class="admin-bottom-nav">
        <a href="#today-orders" class="admin-nav-item active" data-route="today-orders">
            <i class="fas fa-calendar-day"></i>
            <span>Today</span>
        </a>
        <a href="#products" class="admin-nav-item" data-route="products">
            <i class="fas fa-boxes"></i>
            <span>Products</span>
        </a>
        <a href="#orders" class="admin-nav-item" data-route="orders">
            <i class="fas fa-receipt"></i>
            <span>Orders</span>
        </a>
        <a href="#slider" class="admin-nav-item" data-route="slider">
            <i class="fas fa-images"></i>
            <span>Slider</span>
        </a>
        <a href="#messages" class="admin-nav-item" data-route="messages">
            <i class="fas fa-envelope"></i>
            <span>Messages</span>
        </a>
    </nav>
</body>
</html>